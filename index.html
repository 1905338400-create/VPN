<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>å°æçš„å‡é‡è®¡åˆ’</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #007AFF;
            --accent: #FF9500;
            --success: #34C759;
            --danger: #FF3B30;
            --gold: #FFD700; /* çˆ†è¡¨è‰² */
            --bg: #F2F2F7;
            --card-bg: #FFFFFF;
            --text-main: #000000;
            --text-sub: #8E8E93;
            --radius: 20px;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, "SF Pro Text", "Helvetica Neue", Arial, sans-serif; }
        body { background-color: var(--bg); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* ====== å¸ƒå±€æ¡†æ¶ ====== */
        .page-container { flex: 1; position: relative; overflow: hidden; }
        .page { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            padding: calc(var(--safe-top) + 10px) 16px calc(var(--safe-bottom) + 85px) 16px;
            overflow-y: auto; opacity: 0; visibility: hidden; 
            transition: opacity 0.2s ease;
            -webkit-overflow-scrolling: touch;
        }
        .page.active { opacity: 1; visibility: visible; z-index: 10; }

        /* ====== å¤´éƒ¨ä¸çŠ¶æ€ ====== */
        .header-section { margin-bottom: 15px; padding-top: 10px; }
        .app-title { font-size: 28px; font-weight: 800; white-space: nowrap; margin-bottom: 8px; letter-spacing: -0.5px; }
        
        .status-banner {
            background: linear-gradient(135deg, #007AFF 0%, #0055B3 100%);
            color: white; padding: 12px 16px; border-radius: 16px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 4px 10px rgba(0,122,255,0.25);
        }
        .status-info h4 { font-size: 16px; font-weight: 700; margin-bottom: 2px; }
        .status-info p { font-size: 12px; opacity: 0.9; }
        .status-icon { font-size: 24px; }

        /* ====== å¡ç‰‡é€šç”¨ ====== */
        .card { background: var(--card-bg); border-radius: var(--radius); padding: 18px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 0.5px solid rgba(0,0,0,0.05); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .card-title { font-size: 17px; font-weight: 700; display: flex; align-items: center; gap: 6px; }
        .card-subtitle { font-size: 12px; color: var(--text-sub); background: #F2F2F7; padding: 3px 8px; border-radius: 6px; }

        /* ====== é¦–é¡µï¼šä½“é‡ ====== */
        .weight-row { display: flex; align-items: baseline; justify-content: space-between; margin-bottom: 8px; }
        .weight-big { font-size: 40px; font-weight: 800; letter-spacing: -1px; line-height: 1; }
        .weight-unit { font-size: 16px; color: var(--text-sub); margin-left: 4px; }
        .record-btn-sm { background: var(--text-main); color: white; padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 600; border: none; }
        
        .progress-track { height: 10px; background: #E5E5EA; border-radius: 5px; overflow: hidden; margin-top: 8px; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #34C759, #30B0C7); width: 0%; border-radius: 5px; transition: width 0.6s ease; }
        .range-labels { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-sub); margin-top: 4px; }

        /* ====== é¦–é¡µï¼šé¥®æ°´ ====== */
        .water-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .water-val { font-size: 20px; font-weight: 700; color: #007AFF; }
        .water-target { font-size: 12px; color: var(--text-sub); }
        .water-ctrls { display: flex; gap: 8px; }
        .water-btn { background: rgba(0,122,255,0.1); color: #007AFF; border: none; padding: 6px 10px; border-radius: 8px; font-size: 12px; font-weight: 600; }
        .water-btn:active { background: rgba(0,122,255,0.2); }

        /* ====== é¦–é¡µï¼šåœ†ç¯ ====== */
        .rings-container { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
        .ring-item { display: flex; flex-direction: column; align-items: center; padding: 15px 10px; text-align: center; }
        .ring-svg-box { position: relative; width: 100px; height: 100px; margin-bottom: 8px; }
        .ring-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; flex-direction: column; align-items: center; }
        .ring-pct-txt { font-size: 22px; font-weight: 800; line-height: 1; }
        .ring-sub-txt { font-size: 10px; color: var(--text-sub); margin-top: 2px; }
        
        /* åœ†ç¯SVGæ ·å¼ */
        svg.ring { transform: rotate(-90deg); width: 100%; height: 100%; }
        circle { fill: none; stroke-width: 8; stroke-linecap: round; }
        .c-bg { stroke: #F2F2F7; }
        .c-val { stroke-dasharray: 251; stroke-dashoffset: 251; transition: stroke-dashoffset 0.8s ease, stroke 0.3s; }
        
        /* çˆ†è¡¨ç‰¹æ•ˆ */
        .ring-item.overload .c-val { stroke: var(--gold) !important; filter: drop-shadow(0 0 4px rgba(255, 215, 0, 0.6)); }
        .ring-item.overload .ring-pct-txt { color: #B8860B; }
        
        .data-label { font-size: 12px; color: var(--text-sub); margin-bottom: 2px; }
        .data-val { font-size: 16px; font-weight: 700; }

        /* ====== å›¾è¡¨ï¼šå›ºå®šåæ ‡è½´ ====== */
        .chart-box { height: 200px; position: relative; width: 100%; display: flex; }
        .chart-y { width: 40px; height: 100%; position: absolute; left: 0; top: 0; z-index: 2; background: rgba(255,255,255,0.95); border-right: 1px solid #f0f0f0; pointer-events: none; }
        .chart-scroll { flex: 1; margin-left: 40px; overflow-x: auto; -webkit-overflow-scrolling: touch; position: relative; }
        .chart-inner { height: 100%; position: relative; }

        /* ====== æ—¥æœŸé€‰æ‹©å™¨ (Week Scroller) ====== */
        .date-scroller { display: flex; gap: 10px; overflow-x: auto; padding: 0 4px 15px 4px; margin-bottom: 5px; }
        .date-card { 
            flex: 0 0 65px; background: #fff; border-radius: 14px; padding: 10px 0;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 2px solid transparent; transition: all 0.2s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.03);
        }
        .date-card.active { border-color: var(--text-main); background: #F2F2F7; transform: scale(1.05); }
        .date-card.done { border-color: var(--success); }
        .date-card.fail { border-color: var(--accent); }
        .date-card .d-day { font-size: 13px; font-weight: 600; margin-bottom: 2px; }
        .date-card .d-date { font-size: 10px; color: var(--text-sub); }

        /* ====== è®­ç»ƒ/é¥®é£Ÿè®¡åˆ’åˆ—è¡¨ ====== */
        .task-list { display: flex; flex-direction: column; }
        .task-item { 
            display: flex; align-items: center; padding: 15px 0; border-bottom: 0.5px solid #F2F2F7; 
            cursor: pointer; transition: background 0.1s;
        }
        .task-check { 
            width: 24px; height: 24px; border-radius: 6px; border: 2px solid #C7C7CC; margin-right: 12px; 
            display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; transition: all 0.2s;
        }
        .task-item.checked .task-check { background: var(--success); border-color: var(--success); }
        .task-item.checked .task-info { opacity: 0.5; text-decoration: line-through; }
        .task-info h4 { font-size: 15px; font-weight: 600; margin-bottom: 2px; }
        .task-info p { font-size: 12px; color: var(--text-sub); }

        /* ====== é¥®é£Ÿèœå•å¡ç‰‡ ====== */
        .menu-card { display: flex; flex-direction: column; gap: 15px; }
        .menu-row { display: flex; align-items: flex-start; justify-content: space-between; border-bottom: 0.5px solid #f5f5f5; padding-bottom: 12px; }
        .menu-row:last-child { border-bottom: none; padding-bottom: 0; }
        .menu-left h5 { font-size: 14px; color: var(--primary); margin-bottom: 4px; font-weight: 700; }
        .menu-left p { font-size: 13px; color: #333; line-height: 1.4; max-width: 200px; }
        .eat-btn { 
            background: #F2F2F7; color: var(--primary); border: none; padding: 6px 12px; border-radius: 8px; 
            font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 4px; transition: all 0.2s;
        }
        .eat-btn.eaten { background: var(--success); color: white; pointer-events: none; }

        /* ====== æ‰‹é£ç´ä¸æŒ‰é’®ç½‘æ ¼ ====== */
        .accordion { margin-top: 15px; }
        .acc-header { display: flex; justify-content: space-between; padding: 12px 0; font-weight: 600; cursor: pointer; }
        .acc-body { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
        .acc-body.open { max-height: 500px; }
        
        .btn-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 10px 0; }
        .quick-btn { 
            background: #fff; border: 1px solid #E5E5EA; padding: 12px; border-radius: 12px; text-align: left;
            display: flex; justify-content: space-between; align-items: center;
        }
        .quick-btn:active { background: #F2F2F7; }

        /* ====== åº•éƒ¨å¯¼èˆª ====== */
        .tab-bar { 
            position: fixed; bottom: 0; left: 0; width: 100%; height: calc(55px + var(--safe-bottom)); 
            background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); border-top: 0.5px solid rgba(0,0,0,0.1); 
            display: flex; padding-bottom: var(--safe-bottom); z-index: 100;
        }
        .tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #C7C7CC; }
        .tab-item.active { color: var(--primary); }
        .tab-icon { font-size: 24px; margin-bottom: 2px; }
        .tab-text { font-size: 10px; font-weight: 500; }

        /* ====== å¼¹çª— ====== */
        .modal-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 200; display: none; justify-content: center; align-items: center; }
        .modal-body { background: white; padding: 24px; border-radius: 20px; width: 80%; max-width: 320px; animation: popUp 0.2s ease; }
        @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    </style>
</head>
<body>

    <div class="page-container">
        
        <div id="home" class="page active">
            <div class="header-section">
                <div class="app-title">å°æçš„å‡é‡è®¡åˆ’</div>
                <div class="status-banner" id="statusBanner">
                    <div class="status-info">
                        <h4 id="todayThemeTitle">å†²åˆºé˜¶æ®µ</h4>
                        <p id="todayThemeDesc">ä»Šæ—¥ï¼šæœ‰æ°§è€åŠ› + ä½ç¢³é«˜è›‹ç™½</p>
                    </div>
                    <div class="status-icon">ğŸ”¥</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-title">ğŸ“‰ ä½“é‡ç®¡ç†</span>
                    <span class="card-subtitle">ç›®æ ‡ 75.0kg</span>
                </div>
                <div class="weight-row">
                    <div>
                        <span class="weight-big" id="dispWeight">--</span><span class="weight-unit">kg</span>
                    </div>
                    <button class="record-btn-sm" onclick="openModal('weight')">+ è®°å½•</button>
                </div>
                <div class="progress-track">
                    <div class="progress-bar" id="weightBar"></div>
                </div>
                <div class="range-labels">
                    <span>åˆå§‹: 85kg</span>
                    <span>ç›®æ ‡: 75kg</span>
                </div>
                
                <div style="margin-top: 20px; padding-top: 15px; border-top: 0.5px solid #f0f0f0;">
                    <div class="water-row">
                        <div>
                            <div class="water-val"><span id="waterVal">0</span> <span style="font-size:12px;color:#888;">/ 2300ml</span></div>
                            <div class="water-target">æ¯æ—¥é¥®æ°´ç›®æ ‡</div>
                        </div>
                        <div class="water-ctrls">
                            <button class="water-btn" onclick="addWater(50)">+50</button>
                            <button class="water-btn" onclick="addWater(100)">+100</button>
                            <button class="water-btn" onclick="openModal('water')">âœï¸</button>
                        </div>
                    </div>
                    <div class="progress-track" style="height:6px; background:#F2F2F7;">
                        <div class="progress-bar" id="waterBar" style="background:#007AFF;"></div>
                    </div>
                </div>
            </div>

            <div class="rings-container">
                <div class="card ring-item" id="burnCard">
                    <div class="ring-svg-box">
                        <svg class="ring" viewBox="0 0 100 100">
                            <circle class="c-bg" cx="50" cy="50" r="42"></circle>
                            <circle class="c-val" id="ringBurn" cx="50" cy="50" r="42" stroke="#FF9500"></circle>
                        </svg>
                        <div class="ring-content">
                            <span class="ring-pct-txt" id="txtBurnPct">0%</span>
                            <span class="ring-sub-txt">å®Œæˆåº¦</span>
                        </div>
                    </div>
                    <div class="data-label">ä»Šæ—¥æ¶ˆè€— (åŸºç¡€+è¿åŠ¨)</div>
                    <div class="data-val" id="txtBurnVal">0 kcal</div>
                    <div style="font-size:10px; color:#aaa; margin-top:2px;" id="txtBurnTarget">ç›®æ ‡: --</div>
                </div>

                <div class="card ring-item" id="eatCard">
                    <div class="ring-svg-box">
                        <svg class="ring" viewBox="0 0 100 100">
                            <circle class="c-bg" cx="50" cy="50" r="42"></circle>
                            <circle class="c-val" id="ringEat" cx="50" cy="50" r="42" stroke="#34C759"></circle>
                        </svg>
                        <div class="ring-content">
                            <span class="ring-pct-txt" id="txtEatPct">0%</span>
                            <span class="ring-sub-txt">å·²æ‘„å…¥</span>
                        </div>
                    </div>
                    <div class="data-label">å‰©ä½™é¢åº¦</div>
                    <div class="data-val" id="txtEatLeft">1900</div>
                    <div style="font-size:10px; color:#aaa; margin-top:2px;">é™é¢: 1900</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><span class="card-title">âš–ï¸ ä½“é‡å˜åŒ–</span><span class="card-subtitle">70-90kg</span></div>
                <div class="chart-box" id="chartWeight"></div>
            </div>
            <div class="card">
                <div class="card-header"><span class="card-title">ğŸ”¥ çƒ­é‡ç¼ºå£</span><span class="card-subtitle">ç›®æ ‡ > 500</span></div>
                <div class="chart-box" id="chartDeficit"></div>
            </div>
            <div class="card">
                <div class="card-header"><span class="card-title">ğŸƒâ€â™‚ï¸ çƒ­é‡æ¶ˆè€—</span><span class="card-subtitle">åŸºå‡†çº¿: 1800</span></div>
                <div class="chart-box" id="chartBurn"></div>
            </div>
            <div class="card">
                <div class="card-header"><span class="card-title">ğŸ½ï¸ çƒ­é‡æ‘„å…¥</span><span class="card-subtitle">ç›‘æ§</span></div>
                <div class="chart-box" id="chartIntake"></div>
            </div>
        </div>

        <div id="train" class="page">
            <div class="header-section">
                <div class="app-title">è®­ç»ƒè®¡åˆ’ ğŸ‹ï¸â€â™‚ï¸</div>
            </div>

            <div class="date-scroller" id="trainDateScroller"></div>

            <div class="card">
                <div class="card-header">
                    <span class="card-title" id="trainPlanTitle">ä»Šæ—¥å¿…åš</span>
                    <span class="card-subtitle" id="trainPlanTotal">æ€»è®¡: 0 kcal</span>
                </div>
                <div class="task-list" id="trainTaskList">
                    </div>
            </div>

            <div class="card">
                <div class="acc-header" onclick="toggleAcc(this)">
                    <span>â• é¢å¤–åŠ ç»ƒ (Extra)</span>
                    <span>â–¼</span>
                </div>
                <div class="acc-body">
                    <div class="btn-grid">
                        <button class="quick-btn" onclick="addExtra('è·‘æ­¥10min', 80)">
                            <div>è·‘æ­¥ <span style="font-size:10px;color:#888;">10m</span></div>
                            <span style="font-weight:700;">80</span>
                        </button>
                        <button class="quick-btn" onclick="addExtra('è·‘æ­¥30min', 250)">
                            <div>è·‘æ­¥ <span style="font-size:10px;color:#888;">30m</span></div>
                            <span style="font-weight:700;">250</span>
                        </button>
                        <button class="quick-btn" onclick="addExtra('å“‘é“ƒ1ç»„', 100)">
                            <div>å“‘é“ƒ <span style="font-size:10px;color:#888;">1ç»„</span></div>
                            <span style="font-weight:700;">100</span>
                        </button>
                        <button class="quick-btn" onclick="addExtra('é©¬æˆ¿å·¥ä½œ', 200)">
                            <div>é©¬æˆ¿ <span style="font-size:10px;color:#888;">1h</span></div>
                            <span style="font-weight:700;">200</span>
                        </button>
                    </div>
                </div>
                
                <div style="margin-top:10px; border-top:0.5px solid #f0f0f0; padding-top:10px;">
                    <div style="font-size:12px; color:#888; margin-bottom:5px;">ä»Šæ—¥å·²åŠ ç»ƒ:</div>
                    <div id="extraLogList" style="font-size:13px;"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><span class="card-title">ğŸ”¥ æ¶ˆè€—è¶‹åŠ¿</span></div>
                <div class="chart-box" id="chartBurnTrain"></div>
            </div>
        </div>

        <div id="diet" class="page">
            <div class="header-section">
                <div class="app-title">é¥®é£Ÿç¼ºå£ ğŸ¥—</div>
            </div>

            <div class="date-scroller" id="dietDateScroller"></div>

            <div class="card">
                <div class="card-header">
                    <span class="card-title">ä»Šæ—¥é£Ÿè°±æ¨è</span>
                    <span class="card-subtitle">ä¸€é”®æ‰“å¡</span>
                </div>
                <div class="menu-card" id="dietMenuList">
                    </div>
            </div>

            <div class="card">
                <div class="acc-header" onclick="toggleAcc(this)">
                    <span>ğŸ–Šï¸ æ‰‹åŠ¨è¡¥å½•</span>
                    <span>â–¼</span>
                </div>
                <div class="acc-body">
                    <div class="btn-grid">
                        <button class="quick-btn" onclick="addFood('ç±³é¥­/ä¸»é£Ÿ', 150)">
                            <div>ğŸš ä¸»é£Ÿ <span style="font-size:10px;color:#888;">1æ‹³</span></div>
                            <b>150</b>
                        </button>
                        <button class="quick-btn" onclick="addFood('è‚‰ç±»/è›‹ç™½', 150)">
                            <div>ğŸ¥© è‚‰ç±» <span style="font-size:10px;color:#888;">1æŒ</span></div>
                            <b>150</b>
                        </button>
                        <button class="quick-btn" onclick="addFood('è”¬èœ', 50)">
                            <div>ğŸ¥¦ è”¬èœ <span style="font-size:10px;color:#888;">1ç›˜</span></div>
                            <b>50</b>
                        </button>
                        <button class="quick-btn" onclick="addFood('æ°´æœ', 60)">
                            <div>ğŸ æ°´æœ <span style="font-size:10px;color:#888;">1ä¸ª</span></div>
                            <b>60</b>
                        </button>
                    </div>
                </div>
                <div style="margin-top:10px; border-top:0.5px solid #f0f0f0; padding-top:10px;">
                    <div style="font-size:12px; color:#888; margin-bottom:5px;">æ‰‹åŠ¨è®°å½•:</div>
                    <div id="manualFoodList" style="font-size:13px;"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><span class="card-title">ğŸ½ï¸ æ‘„å…¥è¶‹åŠ¿</span></div>
                <div class="chart-box" id="chartIntakeDiet"></div>
            </div>
            <div class="card">
                <div class="card-header"><span class="card-title">ğŸ“‰ ç¼ºå£è¶‹åŠ¿</span></div>
                <div class="chart-box" id="chartDeficitDiet"></div>
            </div>
        </div>

    </div>

    <div class="tab-bar">
        <div class="tab-item active" onclick="switchTab('home')">
            <div class="tab-icon">ğŸ“Š</div><div class="tab-text">è¿›åº¦</div>
        </div>
        <div class="tab-item" onclick="switchTab('train')">
            <div class="tab-icon">ğŸ‹ï¸â€â™‚ï¸</div><div class="tab-text">è®­ç»ƒ</div>
        </div>
        <div class="tab-item" onclick="switchTab('diet')">
            <div class="tab-icon">ğŸ¥—</div><div class="tab-text">ç¼ºå£</div>
        </div>
    </div>

    <div class="modal-mask" id="inputModal">
        <div class="modal-body">
            <h3 id="modalTitle" style="margin-bottom:15px;font-weight:700;">è®°å½•æ•°æ®</h3>
            <input type="number" id="modalInput" style="width:100%; padding:12px; font-size:18px; border:1px solid #ddd; border-radius:10px; margin-bottom:15px;">
            <div style="display:flex; gap:10px;">
                <button onclick="closeModal()" style="flex:1; padding:12px; background:#f0f0f0; border:none; border-radius:10px; font-weight:600;">å–æ¶ˆ</button>
                <button onclick="confirmModal()" style="flex:1; padding:12px; background:var(--primary); color:white; border:none; border-radius:10px; font-weight:600;">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        // ============ å…¨å±€é…ç½® ============
        const CONFIG = {
            bmr: 1800, // åŸºç¡€ä»£è°¢ (åŸºå‡†çº¿)
            intakeLimit: 1900,
            waterTarget: 2300,
            startWeight: 85.0,
            targetWeight: 75.0,
        };

        const THEMES = [
            { t:"å‘¨æ—¥æ¢å¤", d:"é©¬æˆ¿æŠ¤ç† + æ ¸å¿ƒ", color:"#34C759" },
            { t:"å‘¨ä¸€å†²åˆº", d:"æœ‰æ°§è€åŠ› + ä½ç¢³é«˜è›‹ç™½", color:"#FF3B30" },
            { t:"å‘¨äºŒä¼‘æ¯", d:"çº¯ä¼‘æ¯ + å…¨å¤©æ§ç¢³", color:"#8E8E93" },
            { t:"å‘¨ä¸‰å¡‘å½¢", d:"ä¸Šè‚¢åŠ›é‡ + å‡è¡¡é¥®é£Ÿ", color:"#007AFF" },
            { t:"å‘¨å››ä¿ƒç¾", d:"ä¸‹è‚¢æ·±è¹² + ç‰›è‚‰é«˜è›‹ç™½", color:"#5856D6" },
            { t:"å‘¨äº”å¾ªç¯", d:"å…¨èº«HIIT + å¤‡æˆ˜å‘¨æœ«", color:"#FF9500" },
            { t:"å‘¨å…­å·¥ä½œ", d:"é«˜å¼ºåº¦æ•™å­¦ + æ­£å¸¸ç¢³æ°´", color:"#FF2D55" }
        ];

        // ä¸¥æ ¼çš„æ•°æ®é—­ç¯ï¼šPlan Sum = Daily Target
        const DAILY_PLANS = [
            { // Sun
                tasks: [{n:"é©¬æˆ¿å·¥ä½œ", c:300}, {n:"æ ¸å¿ƒæ¢å¤", c:150}],
                menu: { b:{n:"å…¨éº¦é¢åŒ…+ç‰›å¥¶", c:400}, l:{n:"é±¼è‚‰+è”¬èœ", c:600}, d:{n:"è”¬èœæ²™æ‹‰", c:300} }
            },
            { // Mon
                tasks: [{n:"å“‘é“ƒå¾ªç¯x4", c:300}, {n:"è·‘æ­¥30åˆ†", c:300}],
                menu: { b:{n:"ç‡•éº¦+é¸¡è›‹x2", c:400}, l:{n:"é¸¡èƒ¸è‚‰+ç±³é¥­", c:600}, d:{n:"ç‰ç±³+é»„ç“œ", c:300} }
            },
            { // Tue
                tasks: [{n:"æ‹‰ä¼¸æ”¾æ¾", c:50}], 
                menu: { b:{n:"é»‘å’–+é¸¡è›‹", c:300}, l:{n:"å»çš®é¸¡è…¿+èœ", c:500}, d:{n:"è‹¹æœ+é…¸å¥¶", c:300} }
            },
            { // Wed
                tasks: [{n:"ä¸Šè‚¢å“‘é“ƒ", c:200}, {n:"å¹³æ¿æ”¯æ’‘", c:100}],
                menu: { b:{n:"å…¨éº¦åŒ…+è±†æµ†", c:400}, l:{n:"ç˜¦ç‰›è‚‰+æ„é¢", c:600}, d:{n:"è”¬èœæ±¤", c:300} }
            },
            { // Thu
                tasks: [{n:"æ·±è¹²x4ç»„", c:250}, {n:"ç®­æ­¥è¹²", c:150}],
                menu: { b:{n:"ç‰›å¥¶+éº¦ç‰‡", c:400}, l:{n:"ç‰›æ’+åœŸè±†", c:700}, d:{n:"ç•ªèŒ„é»„ç“œ", c:200} }
            },
            { // Fri
                tasks: [{n:"æ³¢æ¯”è·³x20", c:150}, {n:"å…¨èº«å¾ªç¯", c:300}],
                menu: { b:{n:"ä¸‰æ˜æ²»", c:450}, l:{n:"æ¸…ç‚’è™¾ä»", c:550}, d:{n:"æ‚ç²®ç²¥", c:300} }
            },
            { // Sat
                tasks: [{n:"é©¬æœ¯æ•™å­¦", c:500}, {n:"ç¡å‰æ‹‰ä¼¸", c:50}],
                menu: { b:{n:"è‚‰åŒ…+è±†æµ†", c:500}, l:{n:"æ­£å¸¸ä¾¿å½“(å°‘æ²¹)", c:700}, d:{n:"æ°´æœé¤", c:300} }
            }
        ];

        // ============ æ•°æ®çŠ¶æ€ (ä¼ªæ•°æ®åº“) ============
        let db = {}; 
        const todayStr = new Date().toISOString().split('T')[0];
        let selectedDate = todayStr;
        let activeModalType = '';

        // åˆå§‹åŒ–æ¨¡æ‹Ÿæ•°æ® (ç”Ÿæˆè¿‡å»14å¤©)
        function initDB() {
            for (let i = 13; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const k = d.toISOString().split('T')[0];
                const dayIdx = d.getDay(); // 0-6
                
                // æ¨¡æ‹Ÿæ•°æ®
                db[k] = {
                    weight: i===0 ? 84.5 : (85 - i*0.05 + Math.random()*0.3),
                    water: i===0 ? 800 : Math.floor(Math.random()*2000),
                    // è®¡åˆ’å®Œæˆæƒ…å†µ [index]
                    planDone: i===0 ? [] : [0,1], 
                    // é¢å¤–è¿åŠ¨ [{name, cal}]
                    extraBurn: i===0 ? [] : (Math.random()>0.7 ? [{n:"åŠ ç»ƒ",c:200}] : []),
                    // é£Ÿè°±æ‰“å¡ {b:bool, l:bool, d:bool}
                    menuDone: i===0 ? {b:false,l:false,d:false} : {b:true,l:true,d:Math.random()>0.5},
                    // æ‰‹åŠ¨é¥®é£Ÿ [{name, cal}]
                    manualFood: []
                };
            }
        }

        // ============ è®¡ç®—é€»è¾‘ (æ ¸å¿ƒé—­ç¯) ============
        function getDayStats(date) {
            if (!db[date]) return null;
            const data = db[date];
            const dayIdx = new Date(date).getDay();
            const plan = DAILY_PLANS[dayIdx];

            // 1. æ¶ˆè€—è®¡ç®—
            // ç›®æ ‡ = è®¡åˆ’æ€»å’Œ
            const targetBurn = plan.tasks.reduce((a, b) => a + b.c, 0);
            // å®é™… = å®Œæˆçš„è®¡åˆ’ + é¢å¤–
            let actualBurn = 0;
            data.planDone.forEach(idx => {
                if(plan.tasks[idx]) actualBurn += plan.tasks[idx].c;
            });
            data.extraBurn.forEach(e => actualBurn += e.c);

            // 2. æ‘„å…¥è®¡ç®—
            // ç›®æ ‡ = CONFIG.intakeLimit
            let actualIntake = 0;
            if(data.menuDone.b) actualIntake += plan.menu.b.c;
            if(data.menuDone.l) actualIntake += plan.menu.l.c;
            if(data.menuDone.d) actualIntake += plan.menu.d.c;
            data.manualFood.forEach(f => actualIntake += f.c);

            // 3. ç¼ºå£ = (åŸºç¡€ + æ´»åŠ¨) - æ‘„å…¥
            const totalBurn = CONFIG.bmr + actualBurn;
            const deficit = totalBurn - actualIntake;

            return { targetBurn, actualBurn, totalBurn, actualIntake, deficit, weight: data.weight, water: data.water };
        }

        // ============ æ¸²æŸ“é€»è¾‘ ============
        function render() {
            renderHeader();
            renderHome();
            renderTrain();
            renderDiet();
            renderCharts();
        }

        function renderHeader() {
            const dayIdx = new Date(todayStr).getDay();
            const theme = THEMES[dayIdx];
            document.getElementById('todayThemeTitle').innerText = theme.t;
            document.getElementById('todayThemeDesc').innerText = "ä»Šæ—¥: " + theme.d;
        }

        function renderHome() {
            const stats = getDayStats(todayStr);
            
            // ä½“é‡
            document.getElementById('dispWeight').innerText = stats.weight.toFixed(1);
            const wPct = ((CONFIG.startWeight - stats.weight) / (CONFIG.startWeight - CONFIG.targetWeight)) * 100;
            document.getElementById('weightBar').style.width = Math.max(0, Math.min(100, wPct)) + "%";

            // é¥®æ°´
            document.getElementById('waterVal').innerText = stats.water;
            const waterPct = Math.min(100, (stats.water / CONFIG.waterTarget) * 100);
            document.getElementById('waterBar').style.width = waterPct + "%";

            // æ¶ˆè€—åœ†ç¯
            const burnPct = (stats.actualBurn / stats.targetBurn) * 100; // å¯èƒ½è¶…è¿‡100
            const burnDisplayPct = Math.min(100, burnPct); // åœ†ç¯æœ¬èº«æœ€å¤š100ï¼Œç‰¹æ•ˆå¦ç®—
            
            const ringBurn = document.getElementById('ringBurn');
            const burnCard = document.getElementById('burnCard');
            ringBurn.style.strokeDashoffset = 251 - (burnDisplayPct/100)*251;
            document.getElementById('txtBurnPct').innerText = Math.round(burnPct) + "%";
            document.getElementById('txtBurnVal').innerText = stats.totalBurn + " kcal";
            document.getElementById('txtBurnTarget').innerText = "ç›®æ ‡: " + (CONFIG.bmr + stats.targetBurn);
            
            // çˆ†è¡¨ç‰¹æ•ˆ (è¶…è¿‡150%)
            if(burnPct >= 150) burnCard.classList.add('overload');
            else burnCard.classList.remove('overload');

            // æ‘„å…¥åœ†ç¯
            const eatPct = Math.min(100, (stats.actualIntake / CONFIG.intakeLimit) * 100);
            document.getElementById('ringEat').style.strokeDashoffset = 251 - (eatPct/100)*251;
            document.getElementById('txtEatPct').innerText = Math.round(eatPct) + "%";
            const left = CONFIG.intakeLimit - stats.actualIntake;
            document.getElementById('txtEatLeft').innerText = left;
            document.getElementById('txtEatLeft').style.color = left < 0 ? 'var(--danger)' : 'var(--text-main)';
        }

        function renderTrain() {
            renderDateScroller('trainDateScroller');
            const data = db[selectedDate];
            const dayIdx = new Date(selectedDate).getDay();
            const plan = DAILY_PLANS[dayIdx];
            const stats = getDayStats(selectedDate);

            // ä»Šæ—¥è®¡åˆ’åˆ—è¡¨
            document.getElementById('trainPlanTotal').innerText = `ç›®æ ‡: ${stats.targetBurn} kcal`;
            let html = '';
            plan.tasks.forEach((task, idx) => {
                const isChecked = data.planDone.includes(idx);
                html += `
                <div class="task-item ${isChecked ? 'checked' : ''}" onclick="toggleTask(${idx})">
                    <div class="task-check">${isChecked ? 'âœ“' : ''}</div>
                    <div class="task-info">
                        <h4>${task.n}</h4>
                        <p>${task.c} kcal</p>
                    </div>
                </div>`;
            });
            document.getElementById('trainTaskList').innerHTML = html;

            // é¢å¤–è®°å½•å±•ç¤º
            const extraDiv = document.getElementById('extraLogList');
            extraDiv.innerHTML = data.extraBurn.length ? 
                data.extraBurn.map((e,i) => `
                    <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:0.5px solid #eee;">
                        <span>${e.n}</span> <span>+${e.c} <span style="color:#f00;cursor:pointer;" onclick="delExtra(${i})">x</span></span>
                    </div>`).join('') : 'æ— ';
        }

        function renderDiet() {
            renderDateScroller('dietDateScroller');
            const data = db[selectedDate];
            const dayIdx = new Date(selectedDate).getDay();
            const menu = DAILY_PLANS[dayIdx].menu;

            // é£Ÿè°±ä¸€é”®æ‰“å¡
            const types = [['b','æ—©é¤'], ['l','åˆé¤'], ['d','æ™šé¤']];
            let menuHtml = '';
            types.forEach(t => {
                const key = t[0];
                const label = t[1];
                const item = menu[key];
                const isEaten = data.menuDone[key];
                menuHtml += `
                <div class="menu-row">
                    <div class="menu-left">
                        <h5>${label} (${item.c} kcal)</h5>
                        <p>${item.n}</p>
                    </div>
                    <button class="eat-btn ${isEaten?'eaten':''}" onclick="eatMenu('${key}')">
                        ${isEaten ? 'å·²åƒ' : 'ğŸ´ åƒè¿‡'}
                    </button>
                </div>`;
            });
            document.getElementById('dietMenuList').innerHTML = menuHtml;

            // æ‰‹åŠ¨è®°å½•
            const manualDiv = document.getElementById('manualFoodList');
            manualDiv.innerHTML = data.manualFood.length ? 
                data.manualFood.map((f,i) => `
                    <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:0.5px solid #eee;">
                        <span>${f.n}</span> <span>+${f.c} <span style="color:#f00;cursor:pointer;" onclick="delFood(${i})">x</span></span>
                    </div>`).join('') : 'æ— ';
        }

        function renderDateScroller(id) {
            const container = document.getElementById(id);
            const dates = Object.keys(db).sort();
            
            let html = '';
            dates.forEach(d => {
                const dayIdx = new Date(d).getDay();
                const weekStr = ["å‘¨æ—¥","å‘¨ä¸€","å‘¨äºŒ","å‘¨ä¸‰","å‘¨å››","å‘¨äº”","å‘¨å…­"][dayIdx];
                const dateShort = d.slice(5);
                const stats = getDayStats(d);
                
                // çŠ¶æ€åˆ¤æ–­ï¼šæ¶ˆè€—è¾¾æ ‡(>=90%) ä¸ºç»¿ï¼Œå¦åˆ™æ©™
                const isDone = (stats.actualBurn / stats.targetBurn) >= 0.9;
                const statusClass = isDone ? 'done' : 'fail';
                const activeClass = d === selectedDate ? 'active' : '';

                html += `
                <div class="date-card ${activeClass} ${statusClass}" onclick="selectDate('${d}')">
                    <div class="d-day">${weekStr}</div>
                    <div class="d-date">${dateShort}</div>
                </div>`;
            });
            container.innerHTML = html;
            // æ»šåŠ¨åˆ°æœ€å
            if(container.scrollLeft === 0) setTimeout(() => container.scrollLeft = container.scrollWidth, 0);
        }

        // ============ äº¤äº’é€»è¾‘ ============
        function switchTab(tab) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            
            // å›¾è¡¨æ¸²æŸ“éœ€è¦ visible æ‰èƒ½å‡†ç¡®è®¡ç®—ï¼Œæ‰€ä»¥åˆ‡Tabæ—¶é‡ç»˜éƒ¨åˆ†å›¾è¡¨
            if(tab === 'home') renderCharts(true); 
            if(tab === 'train') drawChart('chartBurnTrain', 'burn');
            if(tab === 'diet') { drawChart('chartIntakeDiet', 'intake'); drawChart('chartDeficitDiet', 'deficit'); }
            
            // Tabé«˜äº®
            const idx = tab==='home'?0 : tab==='train'?1 : 2;
            document.querySelectorAll('.tab-item')[idx].classList.add('active');
        }

        function selectDate(d) {
            selectedDate = d;
            renderTrain();
            renderDiet();
        }

        function toggleTask(idx) {
            if(selectedDate !== todayStr) return alert("åªèƒ½æ“ä½œä»Šå¤©");
            const list = db[todayStr].planDone;
            const i = list.indexOf(idx);
            if(i > -1) list.splice(i, 1);
            else list.push(idx);
            render();
        }

        function addExtra(name, cal) {
            if(selectedDate !== todayStr) return alert("åªèƒ½æ“ä½œä»Šå¤©");
            db[todayStr].extraBurn.push({n:name, c:cal});
            render();
        }
        function delExtra(idx) { db[todayStr].extraBurn.splice(idx,1); render(); }

        function eatMenu(type) {
            if(selectedDate !== todayStr) return alert("åªèƒ½æ“ä½œä»Šå¤©");
            db[todayStr].menuDone[type] = true;
            render();
        }

        function addFood(name, cal) {
            if(selectedDate !== todayStr) return alert("åªèƒ½æ“ä½œä»Šå¤©");
            db[todayStr].manualFood.push({n:name, c:cal});
            render();
        }
        function delFood(idx) { db[todayStr].manualFood.splice(idx,1); render(); }

        function toggleAcc(header) {
            const body = header.nextElementSibling;
            body.classList.toggle('open');
            header.querySelector('span:last-child').innerText = body.classList.contains('open') ? 'â–²' : 'â–¼';
        }

        function addWater(amount) {
            db[todayStr].water += amount;
            renderHome();
        }

        // å¼¹çª—é€»è¾‘
        function openModal(type) {
            activeModalType = type;
            document.getElementById('inputModal').style.display = 'flex';
            document.getElementById('modalTitle').innerText = type==='weight'?'è®°å½•ä½“é‡ (kg)':'é¥®æ°´è®°å½• (ml)';
        }
        function closeModal() { document.getElementById('inputModal').style.display = 'none'; }
        function confirmModal() {
            const val = parseFloat(document.getElementById('modalInput').value);
            if(val) {
                if(activeModalType === 'weight') db[todayStr].weight = val;
                if(activeModalType === 'water') db[todayStr].water = val;
                render();
            }
            closeModal();
        }

        // ============ å›¾è¡¨ç»˜åˆ¶ (å›ºå®šåæ ‡è½´ + æ»šåŠ¨) ============
        function renderCharts(forceAll = false) {
            // é¦–é¡µ4å›¾
            drawChart('chartWeight', 'weight');
            drawChart('chartDeficit', 'deficit');
            drawChart('chartBurn', 'burn');
            drawChart('chartIntake', 'intake');
        }

        function drawChart(containerId, type) {
            const container = document.getElementById(containerId);
            if(!container || container.offsetParent === null) return; // éšè—æ—¶ä¸ç»˜åˆ¶
            container.innerHTML = '';

            // 1. å‡†å¤‡æ•°æ®
            const dates = Object.keys(db).sort();
            const values = dates.map(d => {
                const s = getDayStats(d);
                if(type === 'weight') return s.weight;
                if(type === 'burn') return s.totalBurn;
                if(type === 'intake') return s.actualIntake;
                if(type === 'deficit') return s.deficit;
            });

            // 2. è®¾å®šèŒƒå›´ä¸é¢œè‰²
            let min, max, color;
            if(type === 'weight') { min=70; max=90; color='#007AFF'; }
            if(type === 'burn') { min=1800; max=3000; color='#FF9500'; } // åŸºå‡†çº¿1800
            if(type === 'intake') { min=0; max=2500; color='#34C759'; }
            if(type === 'deficit') { min=-500; max=1500; color='#5856D6'; }

            // 3. æ„å»ºDOM
            const yAxis = document.createElement('canvas');
            yAxis.className = 'chart-y';
            const scrollBox = document.createElement('div');
            scrollBox.className = 'chart-scroll';
            const contentDiv = document.createElement('div');
            contentDiv.className = 'chart-inner';
            
            const pointW = 40; 
            const totalW = Math.max(scrollBox.clientWidth, dates.length * pointW);
            contentDiv.style.width = totalW + 'px';
            
            const xAxis = document.createElement('canvas');
            xAxis.style.width = '100%'; xAxis.style.height = '100%';
            
            contentDiv.appendChild(xAxis);
            scrollBox.appendChild(contentDiv);
            container.appendChild(yAxis);
            container.appendChild(scrollBox);

            // 4. Chart.js ç»˜åˆ¶ Xè½´ (æ•°æ®)
            new Chart(xAxis, {
                type: 'line',
                data: {
                    labels: dates.map(d=>d.slice(5)),
                    datasets: [{
                        data: values,
                        borderColor: color,
                        borderWidth: 3, // åŠ ç²—
                        pointBackgroundColor: '#fff',
                        pointBorderColor: color,
                        pointRadius: 4,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: false },
                    layout: { padding: {left:10, right:10, top:10, bottom:10} },
                    scales: {
                        y: { display: false, min, max },
                        x: { grid: {display:false}, ticks: {color:'#8E8E93'} }
                    }
                }
            });

            // 5. Chart.js ç»˜åˆ¶ Yè½´ (åˆ»åº¦)
            new Chart(yAxis, {
                type: 'line',
                data: { datasets: [{data:[], borderColor:'transparent'}] }, // ç©ºæ•°æ®åªä¸ºæ’‘å¼€åˆ»åº¦
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: false },
                    layout: { padding: {top:10, bottom:10} },
                    scales: {
                        x: { display: false },
                        y: { 
                            min, max, position:'left',
                            grid: {display:false},
                            ticks: { color:'#333', font:{size:10, weight:'bold'}, maxTicksLimit: 6 }
                        }
                    }
                }
            });

            // æ»šåˆ°æœ€å³
            setTimeout(() => scrollBox.scrollLeft = scrollBox.scrollWidth, 0);
        }

        // ============ å¯åŠ¨ ============
        initDB();
        render();

    </script>
</body>
</html>