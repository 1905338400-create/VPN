<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>å°æçš„å‡é‡å·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* === å…¨å±€è®¾è®¡è§„èŒƒ V6.2 (å®Œå…¨ä¿ç•™) === */
            
            /* åŸºç¡€è‰² */
            --bg: #F5F7FA;
            --card-bg: #FFFFFF;
            --text-main: #1C1C1E;
            --text-sub: #8E8E93;
            --divider: #E5E5EA;

            /* åŠŸèƒ½è‰² */
            --primary: #007AFF;   /* æ ‡å‡† iOS è“ */
            --primary-gradient: linear-gradient(135deg, #007AFF 0%, #5AC8FA 100%);
            
            --burn: #FF9500;      /* æ·±æ©™ */
            --intake: #34C759;    /* æ·±ç»¿ */
            --deficit: #AF52DE;   /* æ·±ç´« */
            --gold: #FFD700;      /* çˆ†è¡¨é‡‘ */
            
            /* å…‰å½± */
            --shadow-card: 0 4px 20px rgba(0, 0, 0, 0.04);
            --shadow-blue: 0 4px 12px rgba(0, 122, 255, 0.25);
            --shadow-gold: 0 0 25px rgba(255, 215, 0, 0.5);
            
            --radius: 20px;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, "SF Pro Text", "Helvetica Neue", sans-serif; }
        body { background-color: var(--bg); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* ====== å¸ƒå±€ ====== */
        .page-container { flex: 1; position: relative; overflow: hidden; }
        .page { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            padding: calc(var(--safe-top) + 10px) 16px calc(var(--safe-bottom) + 90px) 16px;
            overflow-y: auto; opacity: 0; visibility: hidden; 
            transition: opacity 0.2s ease; -webkit-overflow-scrolling: touch;
        }
        .page.active { opacity: 1; visibility: visible; z-index: 10; }

        /* ====== å¤´éƒ¨ ====== */
        .header-section { margin-bottom: 20px; padding-top: 10px; }
        .greeting { font-size: 13px; color: var(--text-sub); font-weight: 500; margin-bottom: 4px; }
        .app-title { font-size: 32px; font-weight: 800; color: var(--text-main); letter-spacing: -0.5px; margin-bottom: 12px; }
        
        .status-banner {
            background: var(--primary-gradient);
            color: white; padding: 16px; border-radius: 18px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 8px 20px rgba(0, 122, 255, 0.2);
        }
        .status-info h4 { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
        .status-info p { font-size: 13px; opacity: 0.95; font-weight: 500; }
        .status-icon { font-size: 32px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); }

        /* ====== å¡ç‰‡é€šç”¨ ====== */
        .card { 
            background: var(--card-bg); border-radius: var(--radius); padding: 20px; margin-bottom: 18px; 
            box-shadow: var(--shadow-card); border: 1px solid rgba(0,0,0,0.02);
        }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .card-title { font-size: 18px; font-weight: 700; color: var(--text-main); }
        .card-subtitle { font-size: 12px; color: var(--text-sub); background: #F2F4F7; padding: 4px 10px; border-radius: 10px; font-weight: 600; }

        /* ====== é¦–é¡µå…ƒç´  ====== */
        .weight-main { display: flex; align-items: baseline; justify-content: space-between; margin-bottom: 12px; }
        .weight-num { font-size: 48px; font-weight: 800; color: var(--text-main); letter-spacing: -1.5px; line-height: 1; }
        .weight-unit { font-size: 18px; color: var(--text-sub); margin-left: 4px; font-weight: 600; }
        
        .record-btn { 
            background: #333; color: white; border: none; padding: 10px 20px; 
            border-radius: 24px; font-size: 14px; font-weight: 600; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.15); transition: transform 0.1s;
        }
        .record-btn:active { transform: scale(0.96); }

        .progress-box { height: 12px; background: #EAEAEA; border-radius: 6px; overflow: hidden; margin-top: 10px; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #34C759, #2E8B57); width: 0%; border-radius: 6px; transition: width 0.8s ease; }
        .progress-labels { display: flex; justify-content: space-between; font-size: 12px; color: var(--text-sub); margin-top: 6px; font-weight: 500; }

        /* é¥®æ°´ */
        .water-section { margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--divider); }
        .water-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .w-btn { 
            background: #E6F0FF; color: var(--primary); border: none; padding: 6px 12px; 
            border-radius: 8px; font-size: 12px; font-weight: 700; margin-left: 6px;
        }
        .w-btn:active { background: #D1E3FF; }
        .w-progress { height: 8px; background: #F0F2F5; border-radius: 4px; overflow: hidden; }
        .w-fill { height: 100%; background: #5AC8FA; width: 0%; transition: width 0.5s; }

        /* åœ†ç¯ */
        .rings-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .ring-card { 
            display: flex; flex-direction: column; align-items: center; padding: 20px 10px; text-align: center; 
            position: relative; overflow: hidden; transition: all 0.3s;
        }
        .ring-card.explode { background: linear-gradient(135deg, #FFFDF5 0%, #FFFFFF 100%); border: 1px solid var(--gold); box-shadow: var(--shadow-gold); }
        .ring-card.explode .ring-val-big { color: #B8860B; } 

        .ring-wrapper { position: relative; width: 110px; height: 110px; margin-bottom: 12px; z-index: 2; }
        .ring-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; flex-direction: column; align-items: center; }
        .ring-val-big { font-size: 26px; font-weight: 800; line-height: 1; color: var(--text-main); }
        .ring-label-small { font-size: 11px; color: var(--text-sub); margin-top: 2px; font-weight: 600; }
        
        svg.ring { transform: rotate(-90deg); width: 100%; height: 100%; }
        circle { fill: none; stroke-width: 10; stroke-linecap: round; }
        .c-bg { stroke: #F0F0F0; }
        .c-val { stroke-dasharray: 283; stroke-dashoffset: 283; transition: stroke-dashoffset 1s cubic-bezier(0.4, 0, 0.2, 1); }

        .data-primary { font-size: 18px; font-weight: 700; color: var(--text-main); z-index: 2; }
        .data-secondary { font-size: 11px; color: var(--text-sub); margin-top: 2px; z-index: 2; }

        /* ====== å›¾è¡¨å®¹å™¨ (ä¿®æ­£) ====== */
        .chart-scroll-box { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 10px; }
        /* çˆ¶å®¹å™¨ï¼Œå®½åº¦ç”±JSè®¡ç®— */
        .chart-inner { position: relative; height: 220px; } 
        canvas { width: 100%; height: 100%; display: block; }

        /* ====== ç»„ä»¶æ ·å¼ ====== */
        .date-scroller { display: flex; gap: 10px; overflow-x: auto; padding: 10px 5px 20px 5px; margin: 0 -5px 10px -5px; -webkit-overflow-scrolling: touch; }
        .date-card { flex: 0 0 64px; height: 86px; background: #fff; border-radius: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 2px solid transparent; transition: all 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.03); position: relative; }
        .date-card.status-done { border-color: var(--intake); }
        .date-card.status-fail { border-color: var(--burn); }
        .date-card.is-today { flex: 0 0 76px; height: 100px; background: #F0F8FF; border-color: var(--primary); box-shadow: 0 8px 16px rgba(0, 122, 255, 0.15); z-index: 2; }
        .date-card.active { border-color: #333 !important; transform: translateY(-4px); }
        .d-week { font-size: 13px; font-weight: 700; margin-bottom: 4px; color: var(--text-main); }
        .d-date { font-size: 11px; color: var(--text-sub); font-weight: 500; }
        .is-today .d-week { color: var(--primary); font-size: 15px; }

        .list-item { display: flex; align-items: center; padding: 16px 0; border-bottom: 1px solid var(--divider); cursor: pointer; position: relative; transition: background 0.1s; }
        .list-item:last-child { border-bottom: none; }
        .checkbox { width: 26px; height: 26px; border-radius: 8px; border: 2px solid #C7C7CC; margin-right: 14px; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; font-weight: 800; flex-shrink: 0; transition: all 0.2s; }
        .list-item.checked .checkbox { background: var(--intake); border-color: var(--intake); }
        .list-item.checked .item-info { opacity: 0.4; text-decoration: line-through; }
        .item-info h4 { font-size: 16px; font-weight: 600; color: var(--text-main); line-height: 1.4; }
        .item-info p { font-size: 12px; color: var(--text-sub); margin-top: 3px; }
        .del-btn { margin-left: auto; padding: 6px 12px; font-size: 12px; color: var(--text-sub); background: #F2F2F7; border-radius: 8px; border: none; font-weight: 600; }

        .accordion-box { margin-top: 10px; }
        .acc-header { display: flex; justify-content: space-between; align-items: center; padding: 14px 12px; background: #F9F9F9; border-radius: 12px; margin-bottom: 8px; font-weight: 600; cursor: pointer; color: var(--text-main); }
        .arrow-icon { width: 8px; height: 8px; border-right: 2px solid #999; border-bottom: 2px solid #999; transform: rotate(45deg); transition: transform 0.3s; margin-right: 5px; }
        .acc-header.open .arrow-icon { transform: rotate(-135deg); border-color: var(--primary); }
        .acc-body { display: none; grid-template-columns: 1fr 1fr; gap: 10px; padding-bottom: 15px; }
        .acc-body.show { display: grid; }
        .add-card { background: #fff; border: 1px solid var(--divider); padding: 12px; border-radius: 12px; display: flex; flex-direction: column; gap: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .add-card:active { background: #F5F5F5; transform: scale(0.98); }
        .ac-title { font-size: 14px; font-weight: 600; color: var(--text-main); }
        .ac-val { font-size: 11px; color: var(--text-sub); }

        .tab-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: calc(60px + var(--safe-bottom)); background: rgba(255,255,255,0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 1px solid rgba(0,0,0,0.1); display: flex; padding-bottom: var(--safe-bottom); z-index: 100; }
        .tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #B0B0B0; transition: color 0.2s; }
        .tab-item.active { color: var(--primary); }
        .tab-icon { font-size: 26px; margin-bottom: 2px; }
        .tab-txt { font-size: 10px; font-weight: 600; }

        .toast-box { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(20px); background: rgba(28, 28, 30, 0.95); color: white; padding: 12px 24px; border-radius: 30px; display: flex; align-items: center; gap: 16px; z-index: 300; opacity: 0; pointer-events: none; transition: all 0.3s; box-shadow: 0 10px 30px rgba(0,0,0,0.25); }
        .toast-box.show { opacity: 1; transform: translateX(-50%) translateY(0); pointer-events: auto; }
        .toast-undo { color: var(--gold); font-weight: 700; font-size: 14px; background: none; border: none; cursor: pointer; }

        .modal-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 200; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-box { background: #fff; width: 80%; max-width: 320px; border-radius: 24px; padding: 24px; text-align: center; }
        .inp-lg { width: 100%; padding: 14px; font-size: 22px; text-align: center; border: 2px solid #EAEAEA; border-radius: 14px; margin: 20px 0; color: var(--text-main); font-weight: 700; }
        .modal-btns { display: flex; gap: 12px; }
        .m-btn { flex: 1; padding: 12px; border-radius: 12px; font-weight: 600; border: none; font-size: 15px; }
        .m-cancel { background: #F2F2F7; color: var(--text-sub); }
        .m-save { background: var(--primary); color: white; }
    </style>
</head>
<body>

    <div class="page-container">
        <div id="home" class="page active">
            <div class="header-section">
                <div class="greeting" id="greeting">æ—©å®‰ï¼Œå°ææ•™ç»ƒ</div>
                <div class="app-title">å°æçš„å‡é‡å·¥å…·</div>
                <div class="status-banner">
                    <div class="status-info"><h4 id="themeTitle">--</h4><p id="themeDesc">--</p></div>
                    <div class="status-icon">ğŸ”¥</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><span class="card-title">ğŸ“‰ ä½“é‡ç®¡ç†</span><span class="card-subtitle">ç›®æ ‡ 75.0kg</span></div>
                <div class="weight-main">
                    <div><span class="weight-num" id="dispWeight">--</span><span class="weight-unit">kg</span></div>
                    <button class="record-btn" onclick="openModal('weight')">è®°å½•ä½“é‡</button>
                </div>
                <div class="progress-box"><div class="progress-bar" id="weightBar"></div></div>
                <div class="progress-labels"><span>åˆå§‹: 85kg</span><span>è¿›åº¦: <span id="lostVal">0</span>kg</span><span>ç›®æ ‡: 75kg</span></div>
                
                <div class="water-section">
                    <div class="water-header">
                        <div><span style="font-weight:700;">ğŸ’§ é¥®æ°´</span> <span style="font-size:12px; color:var(--text-sub);"><span id="waterVal" style="color:var(--primary);font-weight:800;font-size:16px;">0</span> / 2300ml</span></div>
                    </div>
                    <div class="w-progress" style="margin-bottom:12px;"><div class="w-fill" id="waterBar"></div></div>
                    <div style="display:flex; justify-content:flex-end;">
                        <button class="w-btn" onclick="addWater(50)">+50</button>
                        <button class="w-btn" onclick="addWater(100)">+100</button>
                        <button class="w-btn" onclick="openModal('water')">âœï¸ è‡ªå®šä¹‰</button>
                    </div>
                </div>
            </div>

            <div class="rings-row">
                <div class="card ring-card" id="burnCard">
                    <div class="ring-wrapper">
                        <svg class="ring" viewBox="0 0 100 100"><circle class="c-bg" cx="50" cy="50" r="45"></circle><circle class="c-val" id="ringBurn" cx="50" cy="50" r="45" stroke="#FF9500"></circle></svg>
                        <div class="ring-center"><span class="ring-val-big" id="txtBurnPct">0%</span><span class="ring-label-small">å®Œæˆåº¦</span></div>
                    </div>
                    <div class="data-primary" id="txtBurnVal">0</div>
                    <div class="data-secondary">ä»Šæ—¥æ¶ˆè€— (åŸºç¡€+è¿åŠ¨)</div>
                </div>
                <div class="card ring-card">
                    <div class="ring-wrapper">
                        <svg class="ring" viewBox="0 0 100 100"><circle class="c-bg" cx="50" cy="50" r="45"></circle><circle class="c-val" id="ringEat" cx="50" cy="50" r="45" stroke="#34C759"></circle></svg>
                        <div class="ring-center"><span class="ring-val-big" id="txtEatPct">0%</span><span class="ring-label-small">å·²æ‘„å…¥</span></div>
                    </div>
                    <div class="data-primary" id="txtEatLeft" style="color:#34C759">1900</div>
                    <div class="data-secondary">å‰©ä½™é¢åº¦ (kcal)</div>
                </div>
            </div>

            <div class="card"><div class="card-header"><span class="card-title">âš–ï¸ ä½“é‡è¶‹åŠ¿</span><span class="card-subtitle">70-90kg</span></div><div class="chart-scroll-box"><div class="chart-inner" id="boxWeight"><canvas id="cWeight"></canvas></div></div></div>
            <div class="card"><div class="card-header"><span class="card-title">ğŸ“‰ çƒ­é‡ç¼ºå£</span><span class="card-subtitle">ç›®æ ‡ > 500</span></div><div class="chart-scroll-box"><div class="chart-inner" id="boxDeficit"><canvas id="cDeficit"></canvas></div></div></div>
            <div class="card"><div class="card-header"><span class="card-title">ğŸ”¥ æ¶ˆè€—è¶‹åŠ¿</span><span class="card-subtitle">åŸºå‡†: 1800</span></div><div class="chart-scroll-box"><div class="chart-inner" id="boxBurn"><canvas id="cBurn"></canvas></div></div></div>
            <div class="card"><div class="card-header"><span class="card-title">ğŸ½ï¸ æ‘„å…¥è¶‹åŠ¿</span><span class="card-subtitle">é™é¢: 1900</span></div><div class="chart-scroll-box"><div class="chart-inner" id="boxIntake"><canvas id="cIntake"></canvas></div></div></div>
        </div>

        <div id="train" class="page">
            <div class="header-section"><div class="app-title">è®­ç»ƒè®¡åˆ’ ğŸ‹ï¸â€â™‚ï¸</div></div>
            <div class="date-scroller" id="trainScroller"></div>
            
            <div class="card">
                <div class="card-header"><span class="card-title" id="trainTitle">å¿…åšé¡¹ç›®</span><span class="card-subtitle" id="trainTarget">ç›®æ ‡: 0</span></div>
                <div class="list-group" id="trainList"></div>
            </div>

            <div class="card">
                <div class="card-header"><span class="card-title">â• åŠ ç»ƒ</span></div>
                <div class="accordion-box">
                    <div class="acc-header" onclick="toggleAcc(this)">ğŸƒâ€â™‚ï¸ æœ‰æ°§è®­ç»ƒ <div class="arrow-icon"></div></div>
                    <div class="acc-body">
                        <div class="add-card" onclick="addLog('extra', 'è·‘æ­¥10min', 80)"><span class="ac-title">è·‘æ­¥ 10m</span><span class="ac-val">80 kcal</span></div>
                        <div class="add-card" onclick="addLog('extra', 'è·‘æ­¥30min', 250)"><span class="ac-title">è·‘æ­¥ 30m</span><span class="ac-val">250 kcal</span></div>
                    </div>
                </div>
                <div class="accordion-box">
                    <div class="acc-header" onclick="toggleAcc(this)">ğŸ’ª æ— æ°§ / é©¬æˆ¿ <div class="arrow-icon"></div></div>
                    <div class="acc-body">
                        <div class="add-card" onclick="addLog('extra', 'å“‘é“ƒ1ç»„', 100)"><span class="ac-title">å“‘é“ƒ 1ç»„</span><span class="ac-val">100 kcal</span></div>
                        <div class="add-card" onclick="addLog('extra', 'é©¬æˆ¿1h', 200)"><span class="ac-title">é©¬æˆ¿å·¥ä½œ 1h</span><span class="ac-val">200 kcal</span></div>
                    </div>
                </div>
                <div id="extraList" class="list-group" style="margin-top:15px; border-top:1px solid var(--divider);"></div>
            </div>
            
            <div class="card"><div class="card-header"><span class="card-title">ğŸ”¥ æ¶ˆè€—è¶‹åŠ¿</span></div><div class="chart-scroll-box"><div class="chart-inner" id="boxBurnT"><canvas id="cBurnT"></canvas></div></div></div>
        </div>

        <div id="diet" class="page">
            <div class="header-section"><div class="app-title">é¥®é£Ÿç¼ºå£ ğŸ¥—</div></div>
            <div class="date-scroller" id="dietScroller"></div>

            <div class="card">
                <div class="card-header"><span class="card-title">æ¨èé£Ÿè°±</span><span class="card-subtitle">æ‰“å¡</span></div>
                <div class="list-group" id="menuList"></div>
            </div>

            <div class="card">
                <div class="card-header"><span class="card-title">â• åŠ é¤</span></div>
                <div class="accordion-box">
                    <div class="acc-header" onclick="toggleAcc(this)">ğŸš ä¸»é£Ÿ (ç¢³æ°´) <div class="arrow-icon"></div></div>
                    <div class="acc-body">
                        <div class="add-card" onclick="addLog('food', 'ç±³é¥­1æ‹³', 150)"><span class="ac-title">ç±³é¥­ 1æ‹³</span><span class="ac-val">150g / 150kcal</span></div>
                        <div class="add-card" onclick="addLog('food', 'ç‰ç±³1æ ¹', 120)"><span class="ac-title">ç‰ç±³ 1æ ¹</span><span class="ac-val">200g / 120kcal</span></div>
                    </div>
                </div>
                <div class="accordion-box">
                    <div class="acc-header" onclick="toggleAcc(this)">ğŸ¥© è›‹ç™½è´¨ <div class="arrow-icon"></div></div>
                    <div class="acc-body">
                        <div class="add-card" onclick="addLog('food', 'ç‰›è‚‰1æŒ', 150)"><span class="ac-title">ç‰›è‚‰ 1æŒ</span><span class="ac-val">100g / 150kcal</span></div>
                        <div class="add-card" onclick="addLog('food', 'é¸¡è›‹1ä¸ª', 70)"><span class="ac-title">é¸¡è›‹ 1ä¸ª</span><span class="ac-val">50g / 70kcal</span></div>
                    </div>
                </div>
                <div class="accordion-box">
                    <div class="acc-header" onclick="toggleAcc(this)">ğŸ è”¬æœ <div class="arrow-icon"></div></div>
                    <div class="acc-body">
                        <div class="add-card" onclick="addLog('food', 'è”¬èœ1ç›˜', 50)"><span class="ac-title">è”¬èœ 1ç›˜</span><span class="ac-val">50 kcal</span></div>
                        <div class="add-card" onclick="addLog('food', 'è‹¹æœ1ä¸ª', 60)"><span class="ac-title">è‹¹æœ 1ä¸ª</span><span class="ac-val">60 kcal</span></div>
                    </div>
                </div>
                <div id="foodList" class="list-group" style="margin-top:15px; border-top:1px solid var(--divider);"></div>
            </div>

            <div class="card"><div class="card-header"><span class="card-title">ğŸ½ï¸ æ‘„å…¥è¶‹åŠ¿</span></div><div class="chart-scroll-box"><div class="chart-inner" id="boxIntakeD"><canvas id="cIntakeD"></canvas></div></div></div>
            <div class="card"><div class="card-header"><span class="card-title">ğŸ“‰ ç¼ºå£è¶‹åŠ¿</span></div><div class="chart-scroll-box"><div class="chart-inner" id="boxDeficitD"><canvas id="cDeficitD"></canvas></div></div></div>
        </div>
    </div>

    <div class="tab-bar">
        <div class="tab-item active" onclick="switchTab('home')"><div class="tab-icon">ğŸ“Š</div><div class="tab-txt">è¿›åº¦</div></div>
        <div class="tab-item" onclick="switchTab('train')"><div class="tab-icon">ğŸ‹ï¸â€â™‚ï¸</div><div class="tab-txt">è®­ç»ƒ</div></div>
        <div class="tab-item" onclick="switchTab('diet')"><div class="tab-icon">ğŸ¥—</div><div class="tab-txt">ç¼ºå£</div></div>
    </div>

    <div class="toast-box" id="toast"><span id="toastMsg">å·²è®°å½•</span><button class="toast-undo" onclick="undoLast()">æ’¤é”€</button></div>
    
    <div class="modal-mask" id="modal">
        <div class="modal-box">
            <h3 id="modalTitle" style="margin-bottom:10px;">è®°å½•æ•°æ®</h3>
            <input type="number" id="inpVal" class="inp-lg" placeholder="è¾“å…¥æ•°å€¼">
            <div class="modal-btns">
                <button class="m-btn m-cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="m-btn m-save" onclick="saveData()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        // ============ å…¨å±€é…ç½® ============
        const CONFIG = { BMR: 1800, MAX_INTAKE: 1900, WATER: 2300, START_W: 85.0, TARGET_W: 75.0 };
        const THEMES = [
            { t:"å‘¨æ—¥æ¢å¤", d:"é©¬æˆ¿æŠ¤ç† + æ ¸å¿ƒ", c:"#2E8B57" },
            { t:"å‘¨ä¸€å†²åˆº", d:"æœ‰æ°§è€åŠ› + ä½ç¢³", c:"#DC143C" },
            { t:"å‘¨äºŒä¼‘æ¯", d:"çº¯ä¼‘æ¯ + å…¨å¤©æ§ç¢³", c:"#666" },
            { t:"å‘¨ä¸‰å¡‘å½¢", d:"ä¸Šè‚¢åŠ›é‡ + å‡è¡¡é¥®é£Ÿ", c:"#0066CC" },
            { t:"å‘¨å››ä¿ƒç¾", d:"ä¸‹è‚¢æ·±è¹² + é«˜è›‹ç™½", c:"#6A5ACD" },
            { t:"å‘¨äº”å¾ªç¯", d:"å…¨èº«HIIT + å¤‡æˆ˜", c:"#FF8C00" },
            { t:"å‘¨å…­å·¥ä½œ", d:"é«˜å¼ºåº¦æ•™å­¦ + æ­£å¸¸ç¢³", c:"#FF1493" }
        ];

        // è¡¥å…¨å•ä½çš„é£Ÿè°±
        const PLANS = [
            { tasks: [{n:"é©¬æˆ¿æŠ¤ç†", c:300}, {n:"æ ¸å¿ƒæ¢å¤", c:150}], menu: { b:{n:"å…¨éº¦é¢åŒ…(2ç‰‡)+ç‰›å¥¶(1ç›’)", c:400}, l:{n:"æ¸…è’¸é±¼(200g)+è”¬èœå±±(ä¸é™é‡)", c:600}, d:{n:"è”¬èœæ²™æ‹‰(å¤§ä»½)", c:300} } },
            { tasks: [{n:"å“‘é“ƒå¾ªç¯x4ç»„", c:300}, {n:"è·‘æ­¥30åˆ†é’Ÿ", c:300}], menu: { b:{n:"ç‡•éº¦(50g)+é¸¡è›‹(2ä¸ª)", c:400}, l:{n:"é¸¡èƒ¸è‚‰(150g)+ç±³é¥­(1æ‹³)", c:600}, d:{n:"ç‰ç±³(1æ ¹)+é»„ç“œ(1æ ¹)", c:300} } },
            { tasks: [{n:"å…¨èº«æ‹‰ä¼¸", c:50}], menu: { b:{n:"é»‘å’–å•¡(1æ¯)+æ°´ç…®è›‹(1ä¸ª)", c:300}, l:{n:"å»çš®é¸¡è…¿(2ä¸ª)+è”¬èœ(300g)", c:500}, d:{n:"è‹¹æœ(1ä¸ª)+æ— ç³–é…¸å¥¶(1ç›’)", c:300} } },
            { tasks: [{n:"ä¸Šè‚¢å“‘é“ƒx4ç»„", c:200}, {n:"å¹³æ¿æ”¯æ’‘x3ç»„", c:100}], menu: { b:{n:"å…¨éº¦ä¸‰æ˜æ²»(1ä¸ª)+è±†æµ†(1æ¯)", c:400}, l:{n:"ç˜¦ç‰›è‚‰(150g)+æ„é¢(1å°ç¢—)", c:600}, d:{n:"è”¬èœæ±¤(1ç¢—)+è±†è…(100g)", c:300} } },
            { tasks: [{n:"æ·±è¹²x4ç»„", c:250}, {n:"ç®­æ­¥è¹²x4ç»„", c:150}], menu: { b:{n:"è„±è„‚å¥¶(1ç›’)+éº¦ç‰‡(50g)", c:400}, l:{n:"ç…ç‰›æ’(150g)+åœŸè±†(1ä¸ª)", c:700}, d:{n:"ç•ªèŒ„(1ä¸ª)+é»„ç“œ(1æ ¹)", c:200} } },
            { tasks: [{n:"æ³¢æ¯”è·³x20", c:150}, {n:"å…¨èº«å¾ªç¯x3ç»„", c:300}], menu: { b:{n:"å…¨éº¦é¢åŒ…(2ç‰‡)+ç…è›‹(1ä¸ª)", c:450}, l:{n:"æ¸…ç‚’è™¾ä»(200g)+æ‚ç²®é¥­(150g)", c:550}, d:{n:"æ‚ç²®ç²¥(1ç¢—)", c:300} } },
            { tasks: [{n:"é©¬æœ¯æ•™å­¦(é«˜å¼º)", c:500}, {n:"ç¡å‰æ‹‰ä¼¸", c:50}], menu: { b:{n:"è‚‰åŒ…(1ä¸ª)+è±†æµ†(1æ¯)", c:500}, l:{n:"æ­£å¸¸ä¾¿å½“(å»æ²¹/1ä»½)", c:700}, d:{n:"æ°´æœæ‹¼ç›˜(200g)", c:300} } }
        ];

        let db = {};
        let dateList = [];
        const todayStr = new Date().toISOString().split('T')[0];
        let selectedDate = todayStr;
        let lastAction = null; 
        let modalType = '';

        function init() {
            setGreeting();
            // ç”Ÿæˆ8å¤©ï¼šå‰2 + ä»Šå¤© + å5
            const base = new Date();
            base.setDate(base.getDate() - 2);
            for(let i=0; i<8; i++) {
                const d = new Date(base);
                d.setDate(base.getDate() + i);
                const k = d.toISOString().split('T')[0];
                dateList.push(k);
                if(!db[k]) {
                    db[k] = {
                        weight: i<2 ? 84.8 - i*0.2 : null,
                        water: i<2 ? 2000 : 0,
                        planDone: i<2 ? [0,1] : [],
                        extra: i<2 ? [{id:1, n:"åŠ ç»ƒ:è·‘æ­¥", c:100}] : [],
                        menuDone: i<2 ? {b:true, l:true, d:true} : {b:false, l:false, d:false},
                        food: []
                    };
                }
            }
            renderAll();
        }

        function setGreeting() {
            const h = new Date().getHours();
            document.getElementById('greeting').innerText = `${h<11?"æ—©å®‰":h<18?"åˆå®‰":"æ™šä¸Šå¥½"}ï¼Œå°ææ•™ç»ƒ`;
        }

        function getStats(date) {
            const dObj = new Date(date);
            const plan = PLANS[dObj.getDay()];
            const data = db[date];
            const targetBurn = plan.tasks.reduce((a,b)=>a+b.c, 0);
            let actualBurn = 0;
            data.planDone.forEach(i => { if(plan.tasks[i]) actualBurn += plan.tasks[i].c; });
            data.extra.forEach(e => actualBurn += e.c);
            let actualIntake = 0;
            if(data.menuDone.b) actualIntake += plan.menu.b.c;
            if(data.menuDone.l) actualIntake += plan.menu.l.c;
            if(data.menuDone.d) actualIntake += plan.menu.d.c;
            data.food.forEach(f => actualIntake += f.c);
            return { targetBurn, actualBurn, totalBurn: CONFIG.BMR + actualBurn, actualIntake, deficit: (CONFIG.BMR + actualBurn) - actualIntake, weight: data.weight, water: data.water };
        }

        function renderAll() {
            renderHeader();
            renderHome();
            renderTrain();
            renderDiet();
            requestAnimationFrame(renderCharts);
        }

        function renderHeader() {
            const t = THEMES[new Date(todayStr).getDay()];
            document.getElementById('themeTitle').innerText = t.t;
            document.getElementById('themeDesc').innerText = t.d;
        }

        function renderHome() {
            const s = getStats(todayStr);
            const w = s.weight || CONFIG.START_W;
            document.getElementById('dispWeight').innerText = w.toFixed(1);
            document.getElementById('lostVal').innerText = (CONFIG.START_W - w).toFixed(1);
            document.getElementById('weightBar').style.width = Math.min(100, ((CONFIG.START_W - w)/(CONFIG.START_W - CONFIG.TARGET_W))*100) + "%";
            document.getElementById('waterVal').innerText = s.water;
            document.getElementById('waterBar').style.width = Math.min(100, (s.water/CONFIG.WATER)*100) + "%";

            const burnPct = (s.actualBurn / (s.targetBurn||1)) * 100;
            const bCard = document.getElementById('burnCard');
            const bTxt = document.getElementById('txtBurnPct');
            document.getElementById('ringBurn').style.strokeDashoffset = 283 - (Math.min(100,burnPct)/100)*283;
            document.getElementById('txtBurnVal').innerText = s.totalBurn;
            if(burnPct >= 150) { bCard.classList.add('explode'); bTxt.innerText = "çˆ†"; } 
            else { bCard.classList.remove('explode'); bTxt.innerText = Math.round(burnPct) + "%"; }

            const eatPct = Math.min(100, (s.actualIntake/CONFIG.MAX_INTAKE)*100);
            document.getElementById('ringEat').style.strokeDashoffset = 283 - (eatPct/100)*283;
            document.getElementById('txtEatPct').innerText = Math.round(eatPct) + "%";
            document.getElementById('txtEatLeft').innerText = CONFIG.MAX_INTAKE - s.actualIntake;
        }

        function renderTrain() {
            renderScroller('trainScroller');
            const data = db[selectedDate];
            const plan = PLANS[new Date(selectedDate).getDay()];
            const s = getStats(selectedDate);
            document.getElementById('trainTitle').innerText = `${selectedDate.slice(5)} å¿…åš`;
            document.getElementById('trainTarget').innerText = `ç›®æ ‡: ${s.targetBurn}`;
            document.getElementById('trainList').innerHTML = plan.tasks.map((t, i) => 
                `<div class="list-item ${data.planDone.includes(i)?'checked':''}" onclick="togglePlan(${i})"><div class="checkbox">${data.planDone.includes(i)?'âœ“':''}</div><div class="item-info"><h4>${t.n}</h4><p>${t.c} kcal</p></div></div>`).join('');
            document.getElementById('extraList').innerHTML = data.extra.map((e, idx) => 
                `<div class="list-item"><div class="item-info"><h4>${e.n}</h4><p>+${e.c} kcal</p></div><button class="del-btn" onclick="delLog('extra', ${idx})">æ’¤é”€</button></div>`).join('');
        }

        function renderDiet() {
            renderScroller('dietScroller');
            const data = db[selectedDate];
            const menu = PLANS[new Date(selectedDate).getDay()].menu;
            document.getElementById('menuList').innerHTML = [['b','æ—©é¤'],['l','åˆé¤'],['d','æ™šé¤']].map(k => {
                const item = menu[k[0]];
                const done = data.menuDone[k[0]];
                const displayN = item.n.replace(/\(([^)]+)\)/g, '<span style="color:#007AFF;font-weight:700;">($1)</span>');
                return `<div class="list-item ${done?'checked':''}" onclick="toggleMenu('${k[0]}')"><div class="checkbox">${done?'âœ“':''}</div><div class="item-info"><h4>${k[1]}: ${displayN}</h4><p>${item.c} kcal</p></div></div>`
            }).join('');
            document.getElementById('foodList').innerHTML = data.food.map((f, idx) => 
                `<div class="list-item"><div class="item-info"><h4>${f.n}</h4><p>+${f.c} kcal</p></div><button class="del-btn" onclick="delLog('food', ${idx})">æ’¤é”€</button></div>`).join('');
        }

        function renderScroller(id) {
            document.getElementById(id).innerHTML = dateList.map(d => {
                const isToday = d === todayStr;
                const active = d === selectedDate ? 'active' : '';
                const s = getStats(d);
                let status = '';
                if(d <= todayStr) status = (s.actualBurn >= s.targetBurn*0.9) ? 'status-done' : 'status-fail';
                const label = isToday ? 'ä»Šå¤©' : ["å‘¨æ—¥","å‘¨ä¸€","å‘¨äºŒ","å‘¨ä¸‰","å‘¨å››","å‘¨äº”","å‘¨å…­"][new Date(d).getDay()];
                return `<div class="date-card ${active} ${status} ${isToday?'is-today':''}" onclick="selectDate('${d}')"><div class="d-week">${label}</div><div class="d-date">${d.slice(5)}</div></div>`
            }).join('');
        }

        // ============ å›¾è¡¨ (ä¿®å¤ç‰ˆ) ============
        let charts = {};
        function renderCharts() {
            const common = { borderWidth: 3, pointRadius: 5, pointBackgroundColor: '#fff', pointBorderWidth: 3, tension: 0.3 };
            
            drawChart('cWeight', 'boxWeight', 'weight', 70, 90, '#0055AA', common);
            drawChart('cBurn', 'boxBurn', 'burn', 1800, 3500, '#FF9500', common);
            drawChart('cIntake', 'boxIntake', 'intake', 0, 2500, '#34C759', common);
            drawChart('cDeficit', 'boxDeficit', 'deficit', -500, 1500, '#AF52DE', common);

            if(document.getElementById('train').classList.contains('active')) drawChart('cBurnT', 'boxBurnT', 'burn', 1800, 3500, '#FF9500', common);
            if(document.getElementById('diet').classList.contains('active')) {
                drawChart('cIntakeD', 'boxIntakeD', 'intake', 0, 2500, '#34C759', common);
                drawChart('cDeficitD', 'boxDeficitD', 'deficit', -500, 1500, '#AF52DE', common);
            }
        }

        function drawChart(canvasId, containerId, type, min, max, color, style) {
            const ctx = document.getElementById(canvasId);
            const container = document.getElementById(containerId);
            if(!ctx || !container) return;
            if(charts[canvasId]) charts[canvasId].destroy();

            // æ ¸å¿ƒä¿®å¤ï¼šJS è®¡ç®—çˆ¶å®¹å™¨å®½åº¦ï¼Œèµ‹å€¼ç»™ DIVï¼Œæ’‘å¼€æ»šåŠ¨æ¡
            const contentWidth = Math.max(window.innerWidth - 40, dateList.length * 60);
            container.style.width = contentWidth + 'px';
            
            const labels = dateList.map(d => d.slice(5));
            const data = dateList.map(d => {
                if(d > todayStr) return null; // æœªæ¥ä¸ç”»çº¿
                const s = getStats(d);
                if(type === 'weight') return s.weight;
                if(type === 'burn') return s.totalBurn;
                if(type === 'intake') return s.actualIntake;
                if(type === 'deficit') return s.deficit;
            });

            charts[canvasId] = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets: [{ data, borderColor: color, pointBorderColor: color, ...style }] },
                options: {
                    responsive: true, // æ¢å¤è‡ªé€‚åº”
                    maintainAspectRatio: false, // å¡«æ»¡çˆ¶ DIV
                    plugins: { legend: false },
                    layout: { padding: 10 },
                    scales: {
                        y: { min, max, grid: { color: '#E5E5EA' }, ticks: { color: '#333', font: { weight:'bold' } } },
                        x: { grid: { display: false }, ticks: { color: '#333', font: { weight:'bold' } } }
                    }
                }
            });
            
            // è‡ªåŠ¨æ»šåˆ°æœ€å³ä¾§
            container.parentElement.scrollLeft = container.parentElement.scrollWidth;
        }

        // ============ äº¤äº’ ============
        function switchTab(t) {
            document.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.tab-item').forEach(e => e.classList.remove('active'));
            document.getElementById(t).classList.add('active');
            const map = { home:0, train:1, diet:2 };
            document.querySelectorAll('.tab-item')[map[t]].classList.add('active');
            renderAll();
        }

        function selectDate(d) { selectedDate = d; renderAll(); }
        function toggleAcc(el) { 
            el.nextElementSibling.style.display = el.nextElementSibling.style.display==='grid'?'none':'grid'; 
            el.classList.toggle('open');
        }
        
        function togglePlan(i) {
            if(selectedDate !== todayStr) return alert("ä»…é™ä»Šæ—¥");
            const arr = db[todayStr].planDone;
            const idx = arr.indexOf(i);
            idx > -1 ? arr.splice(idx, 1) : arr.push(i);
            renderAll();
        }
        function toggleMenu(k) {
            if(selectedDate !== todayStr) return alert("ä»…é™ä»Šæ—¥");
            db[todayStr].menuDone[k] = !db[todayStr].menuDone[k];
            renderAll();
        }
        function addLog(type, n, c) {
            if(selectedDate !== todayStr) return alert("ä»…é™ä»Šæ—¥");
            const arr = type==='extra' ? db[todayStr].extra : db[todayStr].food;
            const item = {id: Date.now(), n, c};
            arr.push(item);
            lastAction = { type, item };
            showToast(`å·²æ·»åŠ : ${n}`);
            renderAll();
        }
        function delLog(type, idx) {
            if(selectedDate !== todayStr) return alert("ä»…é™ä»Šæ—¥");
            const arr = type==='extra' ? db[todayStr].extra : db[todayStr].food;
            arr.splice(idx, 1);
            renderAll();
        }

        function addWater(v) { db[todayStr].water += v; renderAll(); }
        
        function openModal(type) { 
            modalType = type;
            document.getElementById('modal').style.display = 'flex'; 
            document.getElementById('modalTitle').innerText = type==='weight'?'è®°å½•ä½“é‡ (kg)':'è‡ªå®šä¹‰é¥®æ°´ (ml)';
            document.getElementById('inpVal').value = '';
        }
        function closeModal() { document.getElementById('modal').style.display = 'none'; }
        function saveData() {
            const v = parseFloat(document.getElementById('inpVal').value);
            if(!isNaN(v)) {
                if(modalType==='weight') db[todayStr].weight = v;
                if(modalType==='water') db[todayStr].water += v; 
                renderAll();
            }
            closeModal();
        }

        function undoLast() {
            if(!lastAction || !lastAction.item) return;
            const { type, item } = lastAction;
            const arr = type==='extra' ? db[todayStr].extra : db[todayStr].food;
            const idx = arr.findIndex(x => x.id === item.id);
            if(idx > -1) { arr.splice(idx, 1); showToast("å·²æ’¤é”€"); renderAll(); }
            lastAction = null;
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        init();
    </script>
</body>
</html>