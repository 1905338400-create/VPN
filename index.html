<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>å°æçš„å‡é‡è®¡åˆ’</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #007AFF;
            --accent: #FF9500;
            --success: #34C759;
            --danger: #FF3B30;
            --bg: #F2F2F7;
            --card-bg: #FFFFFF;
            --text-main: #1C1C1E;
            --text-sub: #8E8E93;
            --radius: 20px;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, "SF Pro Text", Helvetica, Arial, sans-serif; }
        body { background-color: var(--bg); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* ====== å¸ƒå±€ ====== */
        .page-container { flex: 1; position: relative; overflow: hidden; }
        .page { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            padding: calc(var(--safe-top) + 20px) 20px calc(var(--safe-bottom) + 90px) 20px;
            overflow-y: auto; opacity: 0; visibility: hidden; 
            transition: opacity 0.2s ease;
            -webkit-overflow-scrolling: touch;
        }
        .page.active { opacity: 1; visibility: visible; z-index: 10; }

        /* ====== ç»„ä»¶é£æ ¼ ====== */
        .header-area { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 20px; padding-top: 20px; }
        .app-title { font-size: 28px; font-weight: 800; line-height: 1.1; }
        .theme-badge { font-size: 12px; background: rgba(0,122,255,0.1); color: var(--primary); padding: 4px 10px; border-radius: 12px; font-weight: 600; margin-top: 5px; display: inline-block;}
        
        .card { background: var(--card-bg); border-radius: var(--radius); padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); border: 0.5px solid rgba(0,0,0,0.05); position: relative; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .card-title { font-size: 17px; font-weight: 700; color: var(--text-main); display: flex; align-items: center; gap: 6px; }
        .card-subtitle { font-size: 13px; color: var(--text-sub); }

        /* é¦–é¡µ - è¿›åº¦æ¡ */
        .weight-main { display: flex; align-items: baseline; gap: 8px; margin-bottom: 10px; }
        .weight-num { font-size: 38px; font-weight: 800; letter-spacing: -1px; }
        .weight-unit { font-size: 16px; color: var(--text-sub); }
        .record-btn { background: var(--primary); color: white; border: none; padding: 6px 12px; border-radius: 14px; font-size: 13px; font-weight: 600; margin-left: auto; cursor: pointer; }
        .progress-box { margin-top: 15px; }
        .progress-bg { height: 12px; background: #E5E5EA; border-radius: 6px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #007AFF, #5AC8FA); width: 0%; border-radius: 6px; transition: width 0.5s ease; }
        .progress-labels { display: flex; justify-content: space-between; margin-top: 6px; font-size: 12px; color: var(--text-sub); }

        /* é¦–é¡µ - åœ†ç¯ */
        .rings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .ring-card { display: flex; flex-direction: column; align-items: center; text-align: center; padding: 20px 10px; }
        .ring-wrapper { position: relative; width: 100px; height: 100px; margin-bottom: 12px; }
        .ring-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; flex-direction: column; align-items: center; }
        .ring-pct { font-size: 22px; font-weight: 800; line-height: 1; }
        .ring-sub { font-size: 10px; color: var(--text-sub); margin-top: 2px; }
        .formula-box { background: #F2F2F7; padding: 6px 10px; border-radius: 8px; width: 100%; }
        .formula-title { font-size: 11px; color: var(--text-sub); margin-bottom: 2px; }
        .formula-val { font-size: 15px; font-weight: 700; color: var(--text-main); }
        .formula-desc { font-size: 9px; color: #C7C7CC; margin-top: 2px; transform: scale(0.95); transform-origin: center; white-space: nowrap; }
        
        svg.ring { transform: rotate(-90deg); width: 100%; height: 100%; }
        circle { fill: none; stroke-width: 8; stroke-linecap: round; }
        .ring-bg-c { stroke: #F2F2F7; }
        .ring-val-c { stroke-dasharray: 251; stroke-dashoffset: 251; transition: stroke-dashoffset 1s ease; }

        /* ====== å›¾è¡¨å›ºå®šåæ ‡è½´æŠ€æœ¯ ====== */
        .chart-container { position: relative; height: 180px; width: 100%; display: flex; }
        .chart-y-axis { width: 35px; height: 100%; position: absolute; left: 0; top: 0; z-index: 2; background: rgba(255,255,255,0.9); border-right: 1px solid #f0f0f0; pointer-events: none; }
        .chart-scroll-area { flex: 1; overflow-x: auto; margin-left: 35px; -webkit-overflow-scrolling: touch; position: relative; }
        .chart-scroll-content { height: 100%; position: relative; } /* Width set by JS */
        
        /* ====== æ—¥æœŸé€‰æ‹©å™¨ ====== */
        .date-scroller { display: flex; overflow-x: auto; gap: 10px; padding: 5px 5px 15px 5px; -webkit-overflow-scrolling: touch; margin-bottom: 5px; }
        .date-chip { 
            flex: 0 0 auto; min-width: 70px; padding: 10px 0; background: #fff; border-radius: 16px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.03); border: 1.5px solid transparent; transition: all 0.2s; position: relative;
        }
        .date-chip.active { border-color: var(--primary); background: rgba(0,122,255,0.05); }
        .date-chip.today-highlight { box-shadow: 0 4px 12px rgba(0,122,255,0.2); }
        
        .date-week { font-size: 14px; font-weight: 600; color: var(--text-main); margin-bottom: 2px; }
        .date-val { font-size: 11px; color: var(--text-sub); }
        
        .status-dot { width: 6px; height: 6px; border-radius: 50%; margin-top: 6px; background: #E5E5EA; }
        .status-dot.done { background: var(--success); }
        .status-dot.fail { background: var(--accent); }

        /* ====== è®¡åˆ’åˆ—è¡¨ (Interactive) ====== */
        .plan-list { display: flex; flex-direction: column; gap: 0; }
        .plan-item { 
            display: flex; align-items: center; padding: 14px 0; border-bottom: 0.5px solid #F2F2F7; 
            cursor: pointer; transition: all 0.2s; position: relative;
        }
        .plan-item:last-child { border-bottom: none; }
        .plan-checkbox { 
            width: 22px; height: 22px; border-radius: 50%; border: 2px solid #C7C7CC; margin-right: 12px; 
            display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; transition: all 0.2s;
        }
        .plan-content { flex: 1; }
        .plan-name { font-size: 15px; font-weight: 600; color: var(--text-main); margin-bottom: 2px; }
        .plan-cal { font-size: 12px; color: var(--text-sub); }
        
        .plan-item.completed .plan-checkbox { background: var(--success); border-color: var(--success); }
        .plan-item.completed .plan-name { text-decoration: line-through; color: #C7C7CC; }
        
        /* ====== æ‰‹é£ç´ (Accordion) ====== */
        .accordion-group { display: flex; flex-direction: column; gap: 12px; }
        .accordion-item { background: #fff; border-radius: 16px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.02); border: 0.5px solid rgba(0,0,0,0.05); }
        .accordion-header { padding: 16px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .accordion-title { font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .arrow { width: 10px; height: 10px; border-right: 2px solid #C7C7CC; border-bottom: 2px solid #C7C7CC; transform: rotate(45deg); transition: transform 0.3s; }
        .accordion-item.expanded .arrow { transform: rotate(-135deg); border-color: var(--primary); }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; background: #FAFAFC; }
        
        .opt-grid { display: grid; grid-template-columns: 1fr; padding: 10px 15px 15px 15px; gap: 8px; }
        .opt-btn { 
            display: flex; justify-content: space-between; align-items: center; padding: 12px 14px; 
            background: #fff; border-radius: 10px; border: 1px solid #E5E5EA; 
        }
        .opt-btn:active { background: #F2F2F7; transform: scale(0.98); }

        /* ====== åº•éƒ¨å¯¼èˆª ====== */
        .tab-bar { 
            position: fixed; bottom: 0; left: 0; width: 100%; height: calc(55px + var(--safe-bottom)); 
            background: rgba(255,255,255,0.9); backdrop-filter: blur(20px); border-top: 0.5px solid rgba(0,0,0,0.1); 
            display: flex; padding-bottom: var(--safe-bottom); z-index: 100;
        }
        .tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; font-size: 10px; }
        .tab-item.active { color: var(--primary); }
        .tab-icon { font-size: 22px; margin-bottom: 4px; }

        /* ====== å¼¹çª— ====== */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; display: none; justify-content: center; align-items: center; }
        .modal.show { display: flex; }
        .modal-box { background: #fff; padding: 25px; border-radius: 20px; width: 80%; max-width: 320px; animation: popIn 0.2s ease; }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        /* æ—¥å¿—é¡¹ */
        .log-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 0.5px solid #F2F2F7; }
        .del-btn { color: var(--danger); font-size: 12px; padding: 4px 8px; background: rgba(255,59,48,0.08); border-radius: 6px; border: none; }

    </style>
</head>
<body>

    <div class="page-container">
        
        <div id="home" class="page active">
            <div class="header-area">
                <div>
                    <div class="app-title">å°æçš„<br>å‡é‡è®¡åˆ’</div>
                    <div class="theme-badge">å½“å‰ä¸»é¢˜ï¼šå†²åˆºæœŸ</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-title">ğŸ“‰ ä½“é‡è¿›åº¦</span>
                    <span class="card-subtitle">ç›®æ ‡ 75.0kg</span>
                </div>
                <div class="weight-main">
                    <span class="weight-num" id="homeWeightNum">--</span>
                    <span class="weight-unit">kg</span>
                    <button class="record-btn" onclick="openWeightModal()">+ è®°å½•</button>
                </div>
                <div class="progress-box">
                    <div class="progress-bg"><div class="progress-fill" id="homeWeightBar"></div></div>
                    <div class="progress-labels">
                        <span id="startWeightLabel">85kg</span>
                        <span>75kg</span>
                    </div>
                </div>
            </div>

            <div class="rings-grid">
                <div class="card ring-card">
                    <div class="ring-wrapper">
                        <svg class="ring" viewBox="0 0 100 100">
                            <circle class="ring-bg-c" cx="50" cy="50" r="40"></circle>
                            <circle class="ring-val-c" id="ringBurn" cx="50" cy="50" r="40" stroke="#FF9500"></circle>
                        </svg>
                        <div class="ring-center">
                            <span class="ring-pct" id="valBurnPct">0%</span>
                            <span class="ring-sub">kcal</span>
                        </div>
                    </div>
                    <div class="formula-box">
                        <div class="formula-title">è¿˜éœ€æ¶ˆè€—</div>
                        <div class="formula-val" id="valBurnNeeded">500</div>
                        <div class="formula-desc">ç›®æ ‡æ¶ˆè€— - å®é™…æ¶ˆè€—</div>
                    </div>
                </div>
                <div class="card ring-card">
                    <div class="ring-wrapper">
                        <svg class="ring" viewBox="0 0 100 100">
                            <circle class="ring-bg-c" cx="50" cy="50" r="40"></circle>
                            <circle class="ring-val-c" id="ringEat" cx="50" cy="50" r="40" stroke="#34C759"></circle>
                        </svg>
                        <div class="ring-center">
                            <span class="ring-pct" id="valEatPct">0%</span>
                            <span class="ring-sub">kcal</span>
                        </div>
                    </div>
                    <div class="formula-box">
                        <div class="formula-title">è¿˜éœ€æ‘„å…¥</div>
                        <div class="formula-val" id="valEatNeeded">1900</div>
                        <div class="formula-desc">æ‘„å…¥é™é¢ - å®é™…æ‘„å…¥</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><span class="card-title">âš–ï¸ ä½“é‡è¶‹åŠ¿</span><span class="card-subtitle">è¿‘14å¤©</span></div>
                <div class="chart-container" id="chartWeightBox"></div>
            </div>
            <div class="card">
                <div class="card-header"><span class="card-title">ğŸ”¥ çƒ­é‡ç¼ºå£</span><span class="card-subtitle">ç›®æ ‡ > 500</span></div>
                <div class="chart-container" id="chartDeficitBox"></div>
            </div>
            <div class="card">
                <div class="card-header"><span class="card-title">ğŸƒâ€â™‚ï¸ çƒ­é‡æ¶ˆè€—</span><span class="card-subtitle">åŸºç¡€+è¿åŠ¨</span></div>
                <div class="chart-container" id="chartBurnBox"></div>
            </div>
            <div class="card">
                <div class="card-header"><span class="card-title">ğŸ½ï¸ çƒ­é‡æ‘„å…¥</span><span class="card-subtitle">æ¯æ—¥è®°å½•</span></div>
                <div class="chart-container" id="chartIntakeBox"></div>
            </div>
        </div>

        <div id="train" class="page">
            <div class="header-area">
                <div class="app-title">è®­ç»ƒè®¡åˆ’ ğŸ‹ï¸â€â™‚ï¸</div>
            </div>

            <div class="date-scroller" id="trainDateScroller"></div>

            <div class="card">
                <div class="card-header">
                    <span class="card-title" id="trainPlanTitle">ä»Šæ—¥è®¡åˆ’</span>
                    <span class="card-subtitle" style="font-size:11px; background:#F2F2F7; padding:3px 8px; border-radius:6px;" id="trainPlanBadge">å¼ºåº¦</span>
                </div>
                <div class="plan-list" id="trainPlanList">
                    </div>
            </div>

            <h3 style="margin: 20px 0 10px 5px; font-size:16px;">é¢å¤–åŠ ç»ƒ</h3>
            <div class="accordion-group">
                <div class="accordion-item">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <div class="accordion-title"><span style="font-size:18px">ğŸƒâ€â™‚ï¸</span> æœ‰æ°§ (Running)</div>
                        <div class="arrow"></div>
                    </div>
                    <div class="accordion-content">
                        <div class="opt-grid">
                            <div class="opt-btn" onclick="addLog('extra', 'è·‘æ­¥10åˆ†é’Ÿ', 80)">
                                <div><b>è·‘æ­¥</b> <span style="font-size:11px;color:#888;">10min</span></div>
                                <span style="font-size:11px">80kcal</span>
                            </div>
                            <div class="opt-btn" onclick="addLog('extra', 'è·‘æ­¥30åˆ†é’Ÿ', 250)">
                                <div><b>è·‘æ­¥</b> <span style="font-size:11px;color:#888;">30min</span></div>
                                <span style="font-size:11px">250kcal</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <div class="accordion-title"><span style="font-size:18px">ğŸ’ª</span> æ— æ°§ (Extra)</div>
                        <div class="arrow"></div>
                    </div>
                    <div class="accordion-content">
                        <div class="opt-grid">
                            <div class="opt-btn" onclick="addLog('extra', 'é¢å¤–å“‘é“ƒ', 100)">
                                <div><b>å“‘é“ƒå¾ªç¯</b> <span style="font-size:11px;color:#888;">1ç»„</span></div>
                                <span style="font-size:11px">100kcal</span>
                            </div>
                            <div class="opt-btn" onclick="addLog('extra', 'é©¬æˆ¿é‡å·¥', 200)">
                                <div><b>é©¬æˆ¿é‡å·¥</b> <span style="font-size:11px;color:#888;">1å°æ—¶</span></div>
                                <span style="font-size:11px">200kcal</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top:20px;">
                <div class="card-header"><span class="card-title">ä»Šæ—¥å®Œæˆè®°å½•</span></div>
                <div id="trainLogContainer"></div>
            </div>
        </div>

        <div id="diet" class="page">
            <div class="header-area">
                <div class="app-title">é¥®é£Ÿç¼ºå£ ğŸ¥—</div>
            </div>

            <div class="date-scroller" id="dietDateScroller"></div>

            <div class="card">
                <div class="card-header">
                    <span class="card-title">ä»Šæ—¥é£Ÿè°±æ¨è</span>
                    <span class="card-subtitle">æ‰‹æŒé¥®é£Ÿæ³•</span>
                </div>
                <div id="dietMenuDisplay" style="font-size:14px; line-height:1.6; color:#555;">
                    </div>
            </div>

            <h3 style="margin: 20px 0 10px 5px; font-size:16px;">é¥®é£Ÿè®°å½•</h3>
            <div class="accordion-group">
                <div class="accordion-item">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <div class="accordion-title"><span style="font-size:18px">ğŸš</span> ä¸»é£Ÿ (Carbs)</div>
                        <div class="arrow"></div>
                    </div>
                    <div class="accordion-content">
                        <div class="opt-grid">
                            <div class="opt-btn" onclick="addLog('diet', 'ç±³é¥­(1æ‹³)', 180)">
                                <div><b>ç±³é¥­</b> <span style="font-size:11px;color:#888;">150g</span></div>
                                <span>180kcal</span>
                            </div>
                            <div class="opt-btn" onclick="addLog('diet', 'ç‰ç±³(1æ ¹)', 110)">
                                <div><b>ç‰ç±³</b> <span style="font-size:11px;color:#888;">200g</span></div>
                                <span>110kcal</span>
                            </div>
                            <div class="opt-btn" onclick="addLog('diet', 'ç‡•éº¦(1ç¢—)', 140)">
                                <div><b>ç‡•éº¦</b> <span style="font-size:11px;color:#888;">æ³¡æ°´</span></div>
                                <span>140kcal</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <div class="accordion-title"><span style="font-size:18px">ğŸ¥©</span> è›‹ç™½è´¨ (Protein)</div>
                        <div class="arrow"></div>
                    </div>
                    <div class="accordion-content">
                        <div class="opt-grid">
                            <div class="opt-btn" onclick="addLog('diet', 'ç‰›è‚‰(1æŒ)', 150)">
                                <div><b>ç‰›è‚‰</b> <span style="font-size:11px;color:#888;">100g</span></div>
                                <span>150kcal</span>
                            </div>
                            <div class="opt-btn" onclick="addLog('diet', 'é¸¡èƒ¸(1æŒ)', 120)">
                                <div><b>é¸¡èƒ¸è‚‰</b> <span style="font-size:11px;color:#888;">100g</span></div>
                                <span>120kcal</span>
                            </div>
                            <div class="opt-btn" onclick="addLog('diet', 'é¸¡è›‹(1ä¸ª)', 70)">
                                <div><b>é¸¡è›‹</b> <span style="font-size:11px;color:#888;">50g</span></div>
                                <span>70kcal</span>
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="accordion-item">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <div class="accordion-title"><span style="font-size:18px">ğŸ</span> è”¬æœ (Veg/Fruit)</div>
                        <div class="arrow"></div>
                    </div>
                    <div class="accordion-content">
                        <div class="opt-grid">
                            <div class="opt-btn" onclick="addLog('diet', 'è‹¹æœ(1ä¸ª)', 50)">
                                <div><b>è‹¹æœ</b> <span style="font-size:11px;color:#888;">ä¸­ç­‰</span></div>
                                <span>50kcal</span>
                            </div>
                            <div class="opt-btn" onclick="addLog('diet', 'è”¬èœ(1æ§)', 20)">
                                <div><b>è”¬èœ</b> <span style="font-size:11px;color:#888;">ä»»æ„</span></div>
                                <span>20kcal</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top:20px;">
                <div class="card-header"><span class="card-title">ä»Šæ—¥æ‘„å…¥è®°å½•</span></div>
                <div id="dietLogContainer"></div>
            </div>
        </div>

    </div>

    <div class="tab-bar">
        <div class="tab-item active" onclick="switchTab('home')">
            <span class="tab-icon">ğŸ“Š</span><span>è¿›åº¦</span>
        </div>
        <div class="tab-item" onclick="switchTab('train')">
            <span class="tab-icon">ğŸ‹ï¸â€â™‚ï¸</span><span>è®­ç»ƒ</span>
        </div>
        <div class="tab-item" onclick="switchTab('diet')">
            <span class="tab-icon">ğŸ¥—</span><span>ç¼ºå£</span>
        </div>
    </div>

    <div class="modal" id="weightModal">
        <div class="modal-box">
            <h3 style="margin-bottom:15px;">è®°å½•ä»Šæ—¥ä½“é‡</h3>
            <input type="number" id="weightInput" placeholder="85.0" style="width:100%; padding:10px; font-size:20px; margin-bottom:15px; border:1px solid #ddd; border-radius:10px;">
            <button onclick="saveWeight()" style="width:100%; padding:12px; background:var(--primary); color:white; border:none; border-radius:10px; font-size:16px;">ä¿å­˜</button>
            <button onclick="closeWeightModal()" style="width:100%; padding:12px; background:#f0f0f0; color:#333; border:none; border-radius:10px; font-size:16px; margin-top:10px;">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        // ============ é…ç½®ä¸æ•°æ® ============
        const CONFIG = {
            startWeight: 85.0,
            targetWeight: 75.0,
            bmr: 1800, // åŸºç¡€ä»£è°¢ + å·¥ä½œæ—¥å¸¸
            targetBurn: 500, // é¢å¤–è¿åŠ¨ç›®æ ‡
            targetIntake: 1900 // æ‘„å…¥é™é¢
        };

        // æ•°æ®ç”Ÿæˆï¼šè¿‡å»13å¤© + ä»Šå¤©
        // ç»“æ„: 'YYYY-MM-DD': { weight, logs: [], completedPlans: [] }
        let db = {}; 
        let todayStr = new Date().toISOString().split('T')[0];
        let selectedDateStr = todayStr; // å½“å‰é€‰ä¸­çš„æ—¥æœŸ

        // åˆå§‹åŒ–æ¨¡æ‹Ÿæ•°æ®
        function initData() {
            for(let i=13; i>=0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const k = d.toISOString().split('T')[0];
                
                // æ¨¡æ‹Ÿæ³¢åŠ¨
                db[k] = {
                    weight: 85.0 - (Math.random() * 0.5 * (14-i)/14),
                    logs: [], // {id, type: 'diet'|'extra', name, cal}
                    completedPlans: [] // [0, 1] plan indices
                };

                // æ¨¡æ‹Ÿä¸€äº›å†å²æ•°æ®
                if(i > 0) {
                    db[k].logs.push({id: Date.now()+i, type:'diet', name:'æ¨¡æ‹Ÿåˆé¤', cal: 800});
                    if(Math.random() > 0.5) db[k].logs.push({id: Date.now()+i+1, type:'extra', name:'æ¨¡æ‹Ÿè·‘æ­¥', cal: 300});
                }
            }
        }

        // é™æ€è®¡åˆ’é…ç½®
        const weeklyConfig = [
            { day: "å‘¨æ—¥", type: "å·¥ä½œ", items: [{n:"é©¬æˆ¿æŠ¤ç†", c:300}, {n:"æ ¸å¿ƒæ¢å¤", c:100}], menu: "æ—©é¤: å…¨éº¦é¢åŒ…+ç‰›å¥¶ | åˆé¤: æ­£å¸¸åƒé±¼è‚‰ | æ™šé¤: å°‘ç¢³æ°´" }, // 0
            { day: "å‘¨ä¸€", type: "å†²åˆº", items: [{n:"å“‘é“ƒå¾ªç¯x4", c:300}, {n:"è·‘æ­¥30åˆ†", c:300}], menu: "æ—©é¤: ç‡•éº¦+2è›‹ | åˆé¤: é¸¡èƒ¸è‚‰+ç±³é¥­ | æ™šé¤: ç‰ç±³+æ²™æ‹‰" },
            { day: "å‘¨äºŒ", type: "ä¼‘æ¯", items: [{n:"å…¨èº«æ‹‰ä¼¸", c:50}, {n:"æ•£æ­¥", c:100}], menu: "å…¨å¤©æ¸…æ·¡ï¼Œæ™šé¤åªåƒè”¬èœæ°´æœ" },
            { day: "å‘¨ä¸‰", type: "å¡‘å½¢", items: [{n:"ä¸Šè‚¢å“‘é“ƒ", c:200}, {n:"å¹³æ¿æ”¯æ’‘", c:50}], menu: "æ­£å¸¸æ§å¡é¤ï¼Œç»ƒåè¡¥å……è›‹ç™½" },
            { day: "å‘¨å››", type: "ä¿ƒç¾", items: [{n:"ä¸‹è‚¢æ·±è¹²", c:250}, {n:"å·è…¹", c:50}], menu: "åˆé¤å¤šåƒç‰›è‚‰ï¼Œæ™šé¤æ¸…æ·¡" },
            { day: "å‘¨äº”", type: "å¾ªç¯", items: [{n:"å…¨èº«å¾ªç¯", c:300}, {n:"æ³¢æ¯”è·³", c:100}], menu: "åŒå‘¨ä¸€ï¼Œå¤‡æˆ˜å‘¨æœ«" },
            { day: "å‘¨å…­", type: "å·¥ä½œ", items: [{n:"é©¬æœ¯æ•™å­¦", c:400}, {n:"ç¡å‰æ‹‰ä¼¸", c:50}], menu: "æ—©é¤åƒé¥±ï¼Œåˆé¤åƒå¥½ï¼Œæ™šé¤å°‘åƒ" }
        ];

        // ============ æ ¸å¿ƒé€»è¾‘ ============

        function getDayData(dateStr) {
            if(!db[dateStr]) db[dateStr] = { weight: null, logs: [], completedPlans: [] };
            return db[dateStr];
        }

        function calculateStats(dateStr) {
            const data = getDayData(dateStr);
            const dayOfWeek = new Date(dateStr).getDay();
            const planConfig = weeklyConfig[dayOfWeek];

            // 1. æ¶ˆè€—è®¡ç®—
            let burned = 0;
            // A. è®¡åˆ’æ¶ˆè€—
            data.completedPlans.forEach(idx => {
                if(planConfig.items[idx]) burned += planConfig.items[idx].c;
            });
            // B. é¢å¤–æ‰“å¡æ¶ˆè€—
            data.logs.filter(l => l.type === 'extra').forEach(l => burned += l.cal);

            // 2. æ‘„å…¥è®¡ç®—
            let eaten = 0;
            data.logs.filter(l => l.type === 'diet').forEach(l => eaten += l.cal);

            return { burned, eaten, weight: data.weight };
        }

        // ============ æ¸²æŸ“ ============

        function renderAll() {
            renderDashboard();
            renderTrainPage();
            renderDietPage();
        }

        // 1. é¦–é¡µæ¸²æŸ“
        function renderDashboard() {
            const stats = calculateStats(todayStr); // é¦–é¡µçœ‹ä»Šå¤©çš„
            const weight = stats.weight || CONFIG.startWeight;
            
            // ä½“é‡æ¨¡å—
            document.getElementById('homeWeightNum').innerText = weight.toFixed(1);
            const lost = CONFIG.startWeight - weight;
            const total = CONFIG.startWeight - CONFIG.targetWeight;
            const pct = Math.min(100, Math.max(0, (lost/total)*100));
            document.getElementById('homeWeightBar').style.width = `${pct}%`;

            // åœ†ç¯
            const burnPct = Math.min(100, Math.round((stats.burned / CONFIG.targetBurn)*100));
            setRing('ringBurn', burnPct);
            document.getElementById('valBurnPct').innerText = `${burnPct}%`;
            document.getElementById('valBurnNeeded').innerText = Math.max(0, CONFIG.targetBurn - stats.burned);

            const eatPct = Math.min(100, Math.round((stats.eaten / CONFIG.targetIntake)*100));
            setRing('ringEat', eatPct);
            document.getElementById('valEatPct').innerText = `${eatPct}%`;
            const eatLeft = CONFIG.targetIntake - stats.eaten;
            document.getElementById('valEatNeeded').innerText = eatLeft;
            document.getElementById('valEatNeeded').style.color = eatLeft < 0 ? 'var(--danger)' : 'var(--text-main)';

            // å›¾è¡¨æ¸²æŸ“ (æ„å»ºæ•°æ®æ•°ç»„)
            const dates = Object.keys(db).sort(); // å‡è®¾keyæ˜¯ISOä¸”æ’åºæ­£ç¡®
            const weightData = [], burnData = [], eatData = [], deficitData = [];
            
            dates.forEach(d => {
                const s = calculateStats(d);
                weightData.push(s.weight || null); // null allows spanning
                burnData.push(s.burned + CONFIG.bmr); // æ€»æ¶ˆè€—
                eatData.push(s.eaten);
                deficitData.push((s.burned + CONFIG.bmr) - s.eaten);
            });

            // æ¸²æŸ“å››ä¸ªå›¾è¡¨
            drawFixedChart('chartWeightBox', weightData, dates, 'weight', 80);
            drawFixedChart('chartDeficitBox', deficitData, dates, 'deficit', 0);
            drawFixedChart('chartBurnBox', burnData, dates, 'burn', 1500);
            drawFixedChart('chartIntakeBox', eatData, dates, 'intake', 1500);
        }

        // 2. è®­ç»ƒé¡µæ¸²æŸ“
        function renderTrainPage() {
            renderDateScroller('trainDateScroller');
            
            const dayIdx = new Date(selectedDateStr).getDay();
            const config = weeklyConfig[dayIdx];
            const data = getDayData(selectedDateStr);

            // ç½®é¡¶è®¡åˆ’
            document.getElementById('trainPlanTitle').innerText = `${config.day}è®¡åˆ’ (${selectedDateStr.slice(5)})`;
            document.getElementById('trainPlanBadge').innerText = config.type;
            
            const planHTML = config.items.map((item, idx) => {
                const isDone = data.completedPlans.includes(idx);
                return `
                <div class="plan-item ${isDone?'completed':''}" onclick="togglePlan(${idx})">
                    <div class="plan-checkbox">${isDone ? 'âœ“' : ''}</div>
                    <div class="plan-content">
                        <div class="plan-name">${item.n}</div>
                        <div class="plan-cal">${item.c} kcal</div>
                    </div>
                </div>`;
            }).join('');
            document.getElementById('trainPlanList').innerHTML = planHTML;

            // æ—¥å¿—åˆ—è¡¨ (åªæ˜¾ç¤º Extra å’Œ Completed Plans?) 
            // éœ€æ±‚è¯´: å®Œæˆçš„è®­ç»ƒåœ¨åé¢æœ‰å®Œæˆæ ‡è¯†. 
            // è¿™é‡Œæˆ‘ä»¬å±•ç¤º "Extra Logs"
            const extraLogs = data.logs.filter(l => l.type === 'extra');
            renderLogList('trainLogContainer', extraLogs);
        }

        // 3. ç¼ºå£é¡µæ¸²æŸ“
        function renderDietPage() {
            renderDateScroller('dietDateScroller');
            
            const dayIdx = new Date(selectedDateStr).getDay();
            const config = weeklyConfig[dayIdx];
            const data = getDayData(selectedDateStr);

            // ç½®é¡¶é£Ÿè°±
            document.getElementById('dietMenuDisplay').innerHTML = `
                <div style="font-weight:600;margin-bottom:4px;color:var(--primary)">${config.day} ${selectedDateStr.slice(5)}</div>
                ${config.menu.split('|').map(m => `<div>â€¢ ${m.trim()}</div>`).join('')}
            `;

            // æ—¥å¿—åˆ—è¡¨
            const dietLogs = data.logs.filter(l => l.type === 'diet');
            renderLogList('dietLogContainer', dietLogs);
        }

        // é€šç”¨ç»„ä»¶æ¸²æŸ“
        function renderDateScroller(containerId) {
            const container = document.getElementById(containerId);
            const dates = Object.keys(db).sort().slice(-10); // æœ€è¿‘10å¤© + æœªæ¥? æš‚åªæ˜¾ç¤ºæ•°æ®åº“æœ‰çš„
            
            // ç¡®ä¿åŒ…å«ä»Šå¤©
            if(!dates.includes(todayStr)) dates.push(todayStr);

            container.innerHTML = dates.map(d => {
                const dateObj = new Date(d);
                const dayStr = weeklyConfig[dateObj.getDay()].day; // å‘¨å‡ 
                const mmdd = `${dateObj.getMonth()+1}-${dateObj.getDate()}`;
                
                const stats = calculateStats(d);
                const isDone = stats.burned >= CONFIG.targetBurn; // ç®€å•åˆ¤å®š: è¿åŠ¨è¾¾æ ‡
                // åªæœ‰è¿‡å»çš„æ—¥å­æ˜¾ç¤ºçŠ¶æ€ç‚¹
                const showDot = d <= todayStr;
                const dotClass = isDone ? 'done' : 'fail';
                
                const activeClass = d === selectedDateStr ? 'active' : '';
                const todayHighlight = d === todayStr ? 'today-highlight' : '';

                return `
                <div class="date-chip ${activeClass} ${todayHighlight}" onclick="switchDate('${d}')">
                    <div class="date-week">${dayStr}</div>
                    <div class="date-val">${mmdd}</div>
                    ${showDot ? `<div class="status-dot ${dotClass}"></div>` : ''}
                </div>`;
            }).join('');
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°å³ä¾§
            setTimeout(() => { container.scrollLeft = container.scrollWidth; }, 0);
        }

        function renderLogList(containerId, list) {
            const el = document.getElementById(containerId);
            if(list.length === 0) {
                el.innerHTML = `<div style="text-align:center;padding:15px;color:#ccc;font-size:12px;">æš‚æ— è®°å½•</div>`;
                return;
            }
            el.innerHTML = list.map(item => `
                <div class="log-item">
                    <div>
                        <div style="font-size:14px;font-weight:600;">${item.name}</div>
                        <div style="font-size:11px;color:#888;">${item.cal} kcal</div>
                    </div>
                    <button class="del-btn" onclick="removeLog(${item.id})">æ’¤é”€</button>
                </div>
            `).join('');
        }

        // ============ äº¤äº’åŠ¨ä½œ ============

        function switchTab(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            
            document.getElementById(id).classList.add('active');
            // é«˜äº®å¯¹åº”Tab
            const map = {'home':0, 'train':1, 'diet':2};
            document.querySelectorAll('.tab-item')[map[id]].classList.add('active');
        }

        function switchDate(d) {
            selectedDateStr = d;
            renderTrainPage();
            renderDietPage();
        }

        function toggleAccordion(header) {
            const item = header.parentElement;
            const content = header.nextElementSibling;
            item.classList.toggle('expanded');
            content.style.maxHeight = item.classList.contains('expanded') ? content.scrollHeight + "px" : null;
        }

        // è®¡åˆ’æ‰“å¡ (ç‚¹å‡»ç½®é¡¶é¡¹)
        function togglePlan(idx) {
            if(selectedDateStr !== todayStr) {
                alert("åªèƒ½æ“ä½œä»Šå¤©çš„è®¡åˆ’å“¦"); // ç®€å•é˜²è¯¯è§¦
                return; 
            }
            const data = getDayData(todayStr);
            const pos = data.completedPlans.indexOf(idx);
            if(pos > -1) {
                data.completedPlans.splice(pos, 1); // å–æ¶ˆ
            } else {
                data.completedPlans.push(idx); // å®Œæˆ
            }
            renderTrainPage();
            renderDashboard(); // æ›´æ–°é¦–é¡µæ•°æ®
        }

        // æ·»åŠ æ—¥å¿— (é¥®é£Ÿ/é¢å¤–è¿åŠ¨)
        function addLog(type, name, cal) {
            getDayData(selectedDateStr).logs.push({
                id: Date.now(),
                type, name, cal
            });
            if(type === 'diet') renderDietPage();
            else renderTrainPage();
            renderDashboard();
        }

        function removeLog(id) {
            const data = getDayData(selectedDateStr);
            data.logs = data.logs.filter(l => l.id !== id);
            renderTrainPage();
            renderDietPage();
            renderDashboard();
        }

        // ä½“é‡
        function openWeightModal() { document.getElementById('weightModal').classList.add('show'); }
        function closeWeightModal() { document.getElementById('weightModal').classList.remove('show'); }
        function saveWeight() {
            const val = parseFloat(document.getElementById('weightInput').value);
            if(val) {
                getDayData(todayStr).weight = val;
                renderDashboard();
                closeWeightModal();
            }
        }

        function setRing(id, pct) {
            const offset = 251 - (pct/100)*251;
            document.getElementById(id).style.strokeDashoffset = offset;
        }

        // ============ å›¾è¡¨ç»˜åˆ¶ (Canvas) ============
        // æ ¸å¿ƒéš¾ç‚¹ï¼šå®ç° Y è½´å›ºå®šï¼ŒX è½´æ»‘åŠ¨çš„åŒå±‚ç»“æ„
        function drawFixedChart(containerId, dataArr, labels, type, minVal) {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; // æ¸…ç©º

            // 1. åˆ›å»ºå·¦ä¾§ Y è½´ Canvas
            const yCanvas = document.createElement('canvas');
            yCanvas.className = 'chart-y-axis';
            container.appendChild(yCanvas);

            // 2. åˆ›å»ºå³ä¾§ X è½´æ»šåŠ¨åŒº
            const scrollArea = document.createElement('div');
            scrollArea.className = 'chart-scroll-area';
            const xCanvas = document.createElement('canvas');
            xCanvas.style.height = '100%';
            // åŠ¨æ€è®¡ç®—å®½åº¦: æ¯ä¸ªç‚¹ 50px
            const contentWidth = Math.max(container.clientWidth - 35, dataArr.length * 50);
            xCanvas.style.width = contentWidth + 'px';
            xCanvas.width = contentWidth * 2; // Retina fix
            xCanvas.height = 360; // 180 * 2
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'chart-scroll-content';
            contentDiv.style.width = contentWidth + 'px';
            contentDiv.appendChild(xCanvas);
            scrollArea.appendChild(contentDiv);
            container.appendChild(scrollArea);
            
            // æ»šåŠ¨åˆ°æœ€å³
            setTimeout(() => scrollArea.scrollLeft = scrollArea.scrollWidth, 0);

            // é…ç½®é¢œè‰²
            let color = '#007AFF';
            if(type === 'deficit') color = '#AF52DE';
            if(type === 'burn') color = '#FF9500';
            if(type === 'intake') color = '#34C759';

            // 3. ç»˜åˆ¶ X è½´æ•°æ®å›¾ (æ—  Y è½´)
            new Chart(xCanvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels.map(d => d.slice(5)), // MM-DD
                    datasets: [{
                        data: dataArr,
                        borderColor: color,
                        backgroundColor: color + '20',
                        borderWidth: 2,
                        pointRadius: 4,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: color,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    layout: { padding: { top: 10, bottom: 10, left: 10, right: 10 } },
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { display: false, min: minVal }, // éšè— Y è½´
                        x: { grid: { display: false } }
                    }
                }
            });

            // 4. ç»˜åˆ¶ Y è½´åˆ»åº¦å›¾ (æ— æ•°æ®)
            // è¿™é‡Œä½¿ç”¨ä¸€ä¸ªå° trick: ç»˜åˆ¶ä¸€ä¸ªé€æ˜æ•°æ®çš„å›¾è¡¨ï¼Œåªæ˜¾ç¤º Y è½´
            new Chart(yCanvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels: [''], 
                    datasets: [{ data: [minVal, Math.max(...dataArr.filter(n=>n)) * 1.1], borderColor: 'transparent' }] // æ’‘å¼€åˆ»åº¦
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: { padding: { top: 10, bottom: 10 } },
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { 
                            position: 'left',
                            min: minVal,
                            grid: { display: false },
                            ticks: { font: { size: 10 }, color: '#8E8E93', maxTicksLimit: 5 }
                        }
                    }
                }
            });
        }

        // ============ å¯åŠ¨ ============
        initData();
        renderAll();

    </script>
</body>
</html>